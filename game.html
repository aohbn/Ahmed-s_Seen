<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ุณูู ุฌูู โข ุงูุจุฏุก</title><link rel="stylesheet" href="assets/style.css">
<script type="module">
import { listQuestions, listCategories, packsByCategory, getSelectedCategories, setSelectedCategories, getSelectedPacks, setSelectedPacks, getTeamNames, setTeamNames, getScores, setScores } from "./assets/app.js";

let selectedCats = []; 
let selectedPacks = getSelectedPacks();
let boardQuestions = {};

function renderScore(){
  const names=getTeamNames(); const s=getScores();
  document.getElementById('nameA').textContent=names.teamA;
  document.getElementById('nameB').textContent=names.teamB;
  document.getElementById('scoreA').textContent=s.A;
  document.getElementById('scoreB').textContent=s.B;
  document.getElementById('turn').textContent=(s.turn==='A'?names.teamA:names.teamB);
  try{ _bindScoreAdjust(); }catch{}
}
function addPoints(team, pts){ const s=getScores(); s[team]+=pts; setScores(s); renderScore(); }
function switchTurn(){ const s=getScores(); s.turn=(s.turn==='A'?'B':'A'); setScores(s); renderScore(); }

function allCategories(){ return listCategories(); }

  wrap.style.display='block';
  const qs = listQuestions();
  selectedCats.forEach(cat=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='6px 0';
    const label=document.createElement('div'); label.textContent='ุงูุญุฒูุฉ ูููุฆุฉ: '+cat;
    const select=document.createElement('select'); select.className='input'; select.style.maxWidth='420px';
    const packs = packsByCategory(cat);
    const allCount = qs.filter(q=> q.category===cat).length;
    const optAny = document.createElement('option'); optAny.value=''; optAny.textContent='ูู ูู ุงูุญุฒู (ุนุฏุฏ ุงูุฃุณุฆูุฉ: '+allCount+')'; select.appendChild(optAny);
    packs.forEach(p=>{ 
      const m = qs.filter(q=> q.category===cat && q.pack===p.id).length;
      const o=document.createElement('option'); o.value=p.id; o.textContent='ุญุฒูุฉ: '+p.name+' (ุนุฏุฏ: '+m+')'; 
      select.appendChild(o); 
    });
    select.value = selectedPacks[cat]||'';
    select.onchange=()=>{ selectedPacks[cat]=select.value||''; setSelectedPacks(selectedPacks); renderChosenBadges(); };
    row.appendChild(label); row.appendChild(select); wrap.appendChild(row);
  });
  renderChosenBadges();
}
    d.textContent = cat + ' โข ' + label;
    badge.appendChild(d);
  });
}


function renderSetup(){
  const all=listCategories(); const grid=document.getElementById('catsGrid'); grid.innerHTML='';
  const saved=getSelectedCategories().filter(c=>all.includes(c));
  selectedCats=saved.length?saved.slice(0,6):all.slice(0,6);
  const qs=listQuestions();
  all.forEach(cat=>{
    const card=document.createElement('div'); card.className='catCard'+(selectedCats.includes(cat)?' active':'');
    const title=document.createElement('h3'); title.textContent=cat; card.appendChild(title);
    const meta=document.createElement('div'); meta.className='row'; 
    const total=qs.filter(q=>q.category===cat).length;
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent='ุนุฏุฏ ุงูุฃุณุฆูุฉ: '+total; meta.appendChild(tag); card.appendChild(meta);

    const drop=document.createElement('div'); drop.className='drop';
    const label=document.createElement('div'); label.textContent='ุงุฎุชุฑ ุงูุญุฒูุฉ ููุฐู ุงููุฆุฉ:';
    const select=document.createElement('select'); select.className='input';
    const packs=packsByCategory(cat);
    const optAny=document.createElement('option'); optAny.value=''; optAny.textContent='ูู ูู ุงูุญุฒู (ุนุฏุฏ: '+total+')'; select.appendChild(optAny);
    packs.forEach(p=>{ const m=qs.filter(q=>q.category===cat && q.pack===p.id).length; const o=document.createElement('option'); o.value=p.id; o.textContent='ุญุฒูุฉ: '+p.name+' (ุนุฏุฏ: '+m+')'; select.appendChild(o); });
    select.value=(selectedPacks||{})[cat]||'';
    select.onchange=()=>{ selectedPacks[cat]=select.value||''; setSelectedPacks(selectedPacks); };
    drop.appendChild(label); drop.appendChild(select); card.appendChild(drop);

    card.onclick=(e)=>{ if(e.target===select) return; 
      if(selectedCats.includes(cat)){ selectedCats=selectedCats.filter(x=>x!==cat); card.classList.remove('active'); }
      else if(selectedCats.length<6){ selectedCats.push(cat); card.classList.add('active'); }
      setSelectedCategories(selectedCats); document.getElementById('selCount').textContent=(selectedCats?.length||0)+'/6';
      document.getElementById('startBtn').disabled=(selectedCats.length!==6);
    };
    grid.appendChild(card);
  });
  document.getElementById('selCount').textContent=(selectedCats?.length||0)+'/6';
  document.getElementById('startBtn').disabled=(selectedCats.length!==6);
  document.getElementById('noData').style.display=all.length?'none':'block';
}

function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function buildBoard(){
  const qs=listQuestions(); boardQuestions={}; selectedCats.forEach(cat=> boardQuestions[cat]={100:[],200:[],300:[],400:[]});
  [100,200,300,400].forEach(level=>{
    selectedCats.forEach(cat=>{
      const chosen = (selectedPacks||{})[cat]||'';
      const bucket=qs.filter(q=> q.category===cat && Number(q.level)===level && (!chosen || q.pack===chosen));
      boardQuestions[cat][level]=bucket.slice();
    });
  });
}
function renderBoard(){
  const board=document.getElementById('board'); board.innerHTML='';
  const head=document.createElement('div'); head.style.display='grid'; head.style.gridTemplateColumns='repeat(6,1fr)'; head.style.gap='12px';
  selectedCats.forEach(cat=>{ const h=document.createElement('div'); h.className='tile'; h.style.minHeight='60px'; h.textContent=cat; head.appendChild(h); });
  board.appendChild(head);
  const levels=[100,100,200,200,300,300,400];
  levels.forEach(level=>{
    const row=document.createElement('div'); row.className='board';
    selectedCats.forEach(cat=>{
      const pool = boardQuestions[cat][level] || [];
      let q=null; if(pool.length){ q=pool.splice(Math.floor(Math.random()*pool.length),1)[0]; }
      const t=document.createElement('div'); t.className='tile'; t.textContent=level;
      if(!q) t.classList.add('disabled'); else t.onclick=()=> openModal(q,cat,level,t);
      row.appendChild(t);
    });
    board.appendChild(row);
  });
}

// Modal and logic
let timer=null, timeLeft=60, stage='regular'; 
let lifeline={ double:false, two:false };

function updT(){ document.getElementById('timer').textContent=String(Math.floor(timeLeft/60)).padStart(2,'0')+':'+String(timeLeft%60).padStart(2,'0'); }
function startT(){ stopT(); timer=setInterval(()=>{ if(timeLeft<=0){ stopT(); onTimeUp(); } else { timeLeft--; updT(); } },1000); }
function stopT(){ if(timer){ clearInterval(timer); timer=null; } }
function onTimeUp(){ if(stage==='regular') toSteal(); }
function toSteal(){ if(stage==='steal') return; const names=getTeamNames(); const s=getScores(); stage='steal'; s.turn=(s.turn==='A'?'B':'A'); setScores(s); renderScore(); timeLeft=10; updT(); document.getElementById('mStage').textContent=' โ ุงูุณุฑูุฉ: '+(s.turn==='A'?names.teamA:names.teamB)+' (10ุซ)'; refreshLifelineRow(); }
function plus20(){ timeLeft+=20; updT(); }
function refreshLifelineRow(){
  const s=getScores(); const names=getTeamNames(); const cur=s.turn; const oth=(cur==='A'?'B':'A');
  const used=s.used||{A:{},B:{}};
  const bTwo=document.getElementById('twoTries');
  const bDouble=document.getElementById('doublePts');
  const bPlus=document.getElementById('plus20');
  const bSteal=document.getElementById('stealBtn');
  bTwo.disabled=!!used[cur].two; bDouble.disabled=!!used[cur].double; bPlus.disabled=!!used[cur].plus20;
  bSteal.textContent='ุณุฑูุฉ ุงูุณุคุงู ('+(oth==='A'?names.teamA:names.teamB)+')';
  bSteal.disabled=!!used[oth].steal || stage==='steal';
}
function _bindScoreAdjust(){ 
  const addA=document.getElementById('addA'); const subA=document.getElementById('subA'); const addB=document.getElementById('addB'); const subB=document.getElementById('subB');
  if(!addA||!subA||!addB||!subB) return;
  const adj=(team,delta)=>{ const s=getScores(); s[team]+=delta; if(s[team]<0) s[team]=0; setScores(s); renderScore(); };
  addA.onclick=()=>adj('A',100); subA.onclick=()=>adj('A',-100); addB.onclick=()=>adj('B',100); subB.onclick=()=>adj('B',-100);
}

function openModal(q,cat,level,tile){
  const names=getTeamNames(); const s=getScores();
  const m=document.getElementById('modal'); m.style.display='grid';
  stage='regular'; lifeline={double:false, two:false}; timeLeft=60; updT();
  document.getElementById('mTitle').textContent=cat+' โข '+level;
  document.getElementById('mStage').textContent=' โ ุงูุฏูุฑ: '+(s.turn==='A'?names.teamA:names.teamB);
  document.getElementById('mQ').textContent = q.q || 'โ';
  document.getElementById('mA').textContent = q.a || '';
  document.getElementById('mA').style.display='none';
  const img=document.getElementById('mImg'); const imgBtn=document.getElementById('openImg'); const imgTag=document.getElementById('imgTag');
  const vwrap=document.getElementById('imgViewer'); const vimg=document.getElementById('viewerImg');
  if(q.img && String(q.img).length>3){
    img.src=q.img; img.classList.add('thumb-img'); img.style.display='block'; imgTag.style.display='inline-flex'; imgBtn.style.display='inline-block';
    img.onclick=()=>{ vimg.src=q.img; vwrap.style.display='grid'; };
    imgBtn.onclick=()=>{ vimg.src=q.img; vwrap.style.display='grid'; };
  } else { img.removeAttribute('src'); img.style.display='none'; imgTag.style.display='none'; imgBtn.style.display='none'; }
  document.getElementById('closeImg').onclick=()=>{ vwrap.style.display='none'; };

  document.getElementById('showA').onclick=()=>{ const el=document.getElementById('mA'); el.style.display=(el.style.display==='none'?'block':'none'); };
  document.getElementById('startTimer').onclick=startT;
  document.getElementById('pauseTimer').onclick=stopT;
  document.getElementById('resetTimer').onclick=()=>{ stopT(); timeLeft=(stage==='steal'?10:60); updT(); };
  document.getElementById('switchTurnTop').onclick=toSteal;
  document.getElementById('plus20').onclick=()=>{ const s=getScores(); const cur=s.turn; if(s.used[cur].plus20) return; plus20(); s.used[cur].plus20=true; setScores(s); refreshLifelineRow(); };
  document.getElementById('doublePts').onclick=()=>{ const s=getScores(); const cur=s.turn; if(s.used[cur].double) return; lifeline.double=true; s.used[cur].double=true; setScores(s); document.getElementById('doublePts').classList.add('primary'); refreshLifelineRow(); };
  document.getElementById('twoTries').onclick=()=>{ const s=getScores(); const cur=s.turn; if(s.used[cur].two) return; lifeline.two=true; s.used[cur].two=true; setScores(s); document.getElementById('twoTries').classList.add('primary'); refreshLifelineRow(); };
  document.getElementById('stealBtn').onclick=()=>{ const s=getScores(); const oth=(s.turn==='A'?'B':'A'); if(s.used[oth].steal || stage==='steal') return; s.used[oth].steal=true; s.turn=oth; setScores(s); renderScore(); stage='regular'; document.getElementById('mStage').textContent=' โ ุงูุฏูุฑ: '+(oth==='A'?names.teamA:names.teamB)+' (ุณุฑูุฉ ุงูุณุคุงู)'; refreshLifelineRow(); };
  document.getElementById('closeM').onclick=()=>{ stopT(); m.style.display='none'; };

  const labelCur = (s.turn==='A'?names.teamA:names.teamB);
  const labelOth = (s.turn==='A'?names.teamB:names.teamA);
  document.getElementById('winCur').textContent='ุงููุงุฆุฒ: '+labelCur+' โ';
  document.getElementById('winOth').textContent='ุงููุงุฆุฒ: '+labelOth+' โ';
  const award = (team)=>{ const pts = lifeline.double? level*2 : level; addPoints(team, pts); switchTurn(); stopT(); m.style.display='none'; };
  document.getElementById('winCur').onclick=()=> award(getScores().turn);
  document.getElementById('winOth').onclick=()=> award(getScores().turn==='A'?'B':'A');
  document.getElementById('winNone').onclick=()=>{ switchTurn(); stopT(); m.style.display='none'; };

  tile.classList.add('disabled'); tile.onclick=null;
  refreshLifelineRow();
  startT();
}

window.addEventListener('DOMContentLoaded',()=>{
  renderScore();
  renderSetup();
  const t=getTeamNames(); document.getElementById('teamA').value=t.teamA; document.getElementById('teamB').value=t.teamB;
  document.getElementById('saveTeams').onclick=()=>{ setTeamNames({teamA:document.getElementById('teamA').value||'ุงููุฑูู 1', teamB:document.getElementById('teamB').value||'ุงููุฑูู 2'}); renderScore(); };
  document.getElementById('startBtn').onclick=(e)=>{ try{ e?.preventDefault(); buildBoard(); renderBoard(); document.getElementById('setup').style.display='none'; document.getElementById('play').style.display='block'; }catch(err){ console.error('Start error', err); alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุจุฏุก ุงููุนุจุฉ. ุชุฃูุฏ ูู ูุฌูุฏ ุฃุณุฆูุฉ ูููุฆุงุช ุงููุฎุชุงุฑุฉ.'); } };
  document.getElementById('swapTurn').onclick=()=>{ switchTurn(); };
  document.getElementById('resetScore').onclick=()=>{ setScores({A:0,B:0,turn:'A', used:{A:{two:false,double:false,plus20:false,steal:false}, B:{two:false,double:false,plus20:false,steal:false}}}); renderScore(); };
});
</script>
</head>
<body>
<main class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div class="row" style="gap:16px">
        <span class="tag">ุงูุฏูุฑ: <b id="turn">โ</b></span>
        <button class="btn" id="swapTurn" type="button">ุชุจุฏูู ุงูุฏูุฑ</button>
      </div>
      <div class="row" style="gap:16px;flex-wrap:wrap">
        <span class="tag"><b id="nameA">ูุฑูู 1</b> โข <span id="scoreA">0</span></span>
        <div class="row" style="gap:6px"><button class="btn" id="addA" type="button">+100</button><button class="btn" id="subA" type="button">-100</button></div>
        <span class="tag"><b id="nameB">ูุฑูู 2</b> โข <span id="scoreB">0</span></span>
        <div class="row" style="gap:6px"><button class="btn" id="addB" type="button">+100</button><button class="btn" id="subB" type="button">-100</button></div>
        <button class="btn danger" id="resetScore" type="button">ุชุตููุฑ ุงูููุงุท</button>
      </div>
    </div>
  </div>

  <div id="setup" class="card">
      <h2 style="margin-top:0">ุงุฎุชุฑ 6 ูุฆุงุช</h2>
      <div id="catsGrid" class="catsGrid"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <span class="tag" id="selCount">0/6</span>
        <button class="btn primary" id="startBtn" type="button" disabled>ุจุฏุก ุงููุนุจุฉ</button>
      </div>
      <div id="noData" class="hint" style="margin-top:14px;display:none">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ุจุนุฏ โ ุงุณุชูุฑุฏ ูู ุตูุญุฉ ุงูุญูุฒู.</div>
    </div>

    <div id="play" style="display:none"> style="display:none">
    <div class="card">
      <h2>ููุญุฉ ุงูุฃุณุฆูุฉ</h2>
      <div id="board"></div>
    </div>
  </div>
</main>

<!-- Question Modal -->
<div class="backdrop" id="modal">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0"><span id="mTitle">โ</span><span id="mStage"></span></h3>
      <button class="btn" id="closeM" type="button">ุฅุบูุงู โ</button>
    </div>
    <div class="row" style="justify-content:space-between;margin:6px 0;flex-wrap:wrap">
      <div class="row">
        <span class="tag" id="timer">00:60</span>
        <button class="btn" id="startTimer" type="button">ุจุฏุก</button>
        <button class="btn" id="pauseTimer" type="button">ุฅููุงู</button>
        <button class="btn" id="resetTimer" type="button">ุฅุนุงุฏุฉ</button>
        <button class="btn" id="switchTurnTop" type="button">ุชุจุฏูู ุงูุฏูุฑ (10ุซ)</button>
      </div>
      <span class="tag" id="imgTag" style="display:none">๐ท ููุฌุฏ ุตูุฑุฉ</span>
    </div>
    <div style="margin-top:6px;font-weight:800" id="mQ">โ</div>
    <img id="mImg" class="thumb-img" style="display:none" />
    <div class="hint" style="margin-top:8px"><b>ุงูุฅุฌุงุจุฉ:</b> <span id="mA" style="display:none"></span></div>
    <div class="row" style="justify-content:center;margin-top:8px">
      <button class="btn" id="showA" type="button">ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุฅุฌุงุจุฉ</button>
      <button class="btn" id="openImg" type="button" style="margin-inline-start:8px">ุนุฑุถ ุงูุตูุฑุฉ ูู ูุงูุฐุฉ</button>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:8px;flex-wrap:wrap">
      <span class="tag">ูุณุงุฆู ูุณุงุนุฏุฉ (ูุฑุฉ ูุงุญุฏุฉ ููู ูุฑูู):</span>
      <div class="row">
        <button class="btn" id="stealBtn" type="button">ุณุฑูุฉ ุงูุณุคุงู (ุงููุฑูู ุงูุขุฎุฑ)</button>
        <button class="btn" id="twoTries" type="button">ุฅุฌุงุจุชุงู</button>
        <button class="btn" id="doublePts" type="button">ร2 ุงูููุงุท</button>
        <button class="btn" id="plus20" type="button">+20ุซ</button>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:10px;flex-wrap:wrap">
      <span class="tag">ุชุญุฏูุฏ ุงููุงุฆุฒ ุจุงูุณุคุงู:</span>
      <div class="row">
        <button class="btn primary" id="winCur" type="button">ุงููุงุฆุฒ: ุงููุฑูู ุงูุญุงูู</button>
        <button class="btn" id="winOth" type="button">ุงููุงุฆุฒ: ุงููุฑูู ุงูุขุฎุฑ</button>
        <button class="btn danger" id="winNone" type="button">ูุง ุฃุญุฏ</button>
      </div>
    </div>
  </div>
</div>

<!-- Image Viewer -->
<div class="backdrop" id="imgViewer" style="display:none">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><h3>ุนุฑุถ ุงูุตูุฑุฉ</h3><button class="btn" id="closeImg" type="button">ุฅุบูุงู โ</button></div>
    <div style="display:grid;place-items:center"><img id="viewerImg" style="max-width:100%;max-height:80vh;object-fit:contain;border-radius:12px;border:1px solid #e2e8f0"/></div>
  </div>
</div>

<footer class="container"><span>ุณูู ุฌูู โข ุงูุจุฏุก</span></footer>
</body></html>
