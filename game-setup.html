<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>سين جيم • الإعداد</title>
<style>
:root{--bg:#0b1220;--card:#0e172e;--line:#2b3550;--tile1:#1c243a;--tile2:#0d1424;--text:#e7e7ea;--accent:#6c8cff}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Tahoma;direction:rtl;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:16px auto;padding:12px}
.row{display:flex;gap:10px;align-items:center} .hint{opacity:.8}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #445;background:#1c2539;color:#fff;cursor:pointer}
.btn.primary{background:#5b7cff} .btn.danger{background:#8b2d2d}
.tag{background:#1b2234;padding:6px 10px;border-radius:999px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
.board{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
.tile{display:grid;place-items:center;min-height:84px;border-radius:16px;background:linear-gradient(180deg,var(--tile1),var(--tile2));border:1px solid var(--line);font-weight:700;cursor:pointer}
.tile.disabled{opacity:.35;cursor:not-allowed}
/* Big category cards */
.catsGrid{display:grid;gap:14px;grid-template-columns:repeat(3,1fr)}
.catCard{background:linear-gradient(180deg,var(--tile1),var(--tile2));border:1px solid var(--line);border-radius:16px;padding:14px;cursor:pointer;min-height:120px;display:flex;flex-direction:column;justify-content:space-between}
.catCard.active{outline:2px solid var(--accent)} .catCard h3{margin:0 0 8px 0;font-size:18px}
.catCard .drop{display:none;margin-top:8px} .catCard.active .drop{display:block} .catCard select{width:100%}
@media(max-width:900px){ .catsGrid{grid-template-columns:repeat(2,1fr)} }
@media(max-width:640px){ .catsGrid{grid-template-columns:1fr} }
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:999}
.modal{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;max-width:980px;width:92vw}
.input{background:#0d1424;color:var(--text);border:1px solid #28324a;border-radius:10px;padding:8px 10px}
.thumb-img{max-height:22vh;max-width:100%;object-fit:contain;border-radius:12px;border:1px solid #e2e8f0;cursor:zoom-in;margin-top:8px}
</style>
</head><body>
<main class="container">
  <div id="setup" class="card">
    <h2 style="margin-top:0">اختر 6 فئات</h2>
    <div id="catsGrid" class="catsGrid"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px">
  <span class="tag" id="selCount">0/6</span>
</div>
<div class="card" style="margin-top:12px">
  <h3 style="margin-top:0">أسماء الفرق</h3>
  <div class="row" style="gap:12px; flex-wrap:wrap">
    <label>الفريق 1</label>
    <input id="teamAInput" type="text" placeholder="الفريق 1" style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1930;color:#fff;">
    <label>الفريق 2</label>
    <input id="teamBInput" type="text" placeholder="الفريق 2" style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1930;color:#fff;">
    <div class="spacer"></div>
    <button class="btn primary" id="startBtn" type="button" disabled>بدء اللعبة</button>
  </div>
</div>
    <div class="hint" id="noData" style="display:none">لا توجد أسئلة بعد — استورد من صفحة الحِزم.</div>
  </div>
</main>

<footer class="container"><span>سين جيم • الإعداد</span></footer>

<script>
// ---- storage keys ----
const K = {
  SETTINGS: "sj:settings",
  PACKS: "sj:packs",
  QUESTIONS: "sj:questions",
  SELECTED_CATS: "sj:selectedCats",
  SELECTED_PACKS: "sj:selectedPacks",
  TEAMS: "sj:teamNames",
  SCORE: "sj:scores"
};

// ---- tiny store ----
const store = {
  get(k, f){ try { return JSON.parse(localStorage.getItem(k)) ?? f; } catch { return f; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};

// ---- defaults ----
(function defaults(){
  if(!store.get(K.SETTINGS,null)) store.set(K.SETTINGS,{ roundTime:60, stealTime:10 });
  if(!store.get(K.PACKS,null)) store.set(K.PACKS,[]);
  if(!store.get(K.QUESTIONS,null)) store.set(K.QUESTIONS,[]);
  if(!store.get(K.SELECTED_CATS,null)) store.set(K.SELECTED_CATS,[]);
  if(!store.get(K.SELECTED_PACKS,null)) store.set(K.SELECTED_PACKS,{});
  if(!store.get(K.TEAMS,null)) store.set(K.TEAMS,{ teamA:"الفريق 1", teamB:"الفريق 2" });
  if(!store.get(K.SCORE,null)) store.set(K.SCORE,{ A:0, B:0, turn:"A", used:{ A:{two:false,double:false,plus20:false,steal:false}, B:{two:false,double:false,plus20:false,steal:false} } });
})();

// ---- preload shared packs/questions if empty ----
function normalizeQ(q){ return { id:q.id||("q_"+Math.random().toString(36).slice(2)), category:q.category||q.cat||"غير مصنفة", pack:q.pack||q.pid||null, level:Number(q.level||q.value||100), q:String(q.q||"").trim(), a:String(q.a||"").trim(), img:q.img||null }; }
async function ensureSharedLoaded(){
  const hasPacks = Array.isArray(store.get(K.PACKS,null)) && store.get(K.PACKS,[]).length>0;
  const hasQs    = Array.isArray(store.get(K.QUESTIONS,null)) && store.get(K.QUESTIONS,[]).length>0;
  if (hasPacks && hasQs) return;
  try{
    const res = await fetch('/assets/packs/packs.json', { cache:'no-store' });
    if(!res.ok) return;
    const data = await res.json();
    const packs = Array.isArray(data?.packs) ? data.packs.map(p=>({ id:p.id||("pack_"+Math.random().toString(36).slice(2)), name:p.name||"بدون اسم", category:p.category||p.cat||"غير مصنفة" })) : [];
    const questions = Array.isArray(data?.questions) ? data.questions.map(normalizeQ) : [];
    if (packs.length) store.set(K.PACKS, packs);
    if (questions.length) store.set(K.QUESTIONS, questions);
  }catch(_e){ /* ignore */ }
}

// ---- helpers ----
const listPacks     = () => store.get(K.PACKS, []);
const listQuestions = () => store.get(K.QUESTIONS, []);
const listCategories = () => {
  const fromPacks = Array.from(new Set(listPacks().map(p => (p.category||"غير مصنفة"))));
  if (fromPacks.length) return fromPacks;
  return Array.from(new Set(listQuestions().map(q => (q.category||"غير مصنفة"))));
};
const packsByCategory = (c) => listPacks().filter(p => (p.category||"غير مصنفة") === c);

const getSelectedCategories = () => store.get(K.SELECTED_CATS, []);
const setSelectedCategories = (v) => store.set(K.SELECTED_CATS, v||[]);

const getSelectedPacks = () => store.get(K.SELECTED_PACKS, {});
const setSelectedPacks = (m) => store.set(K.SELECTED_PACKS, m||{});

const getTeamNames = () => store.get(K.TEAMS, {teamA:"الفريق 1", teamB:"الفريق 2"});
const setTeamNames = (n) => store.set(K.TEAMS, { teamA: (n.teamA||"الفريق 1"), teamB: (n.teamB||"الفريق 2") });

// ---- page state ----
let selectedCats = getSelectedCategories();
let selectedPacks = getSelectedPacks();

// ---- render setup grid ----
function renderSetup(){
  const cats = listCategories();
  const grid = document.getElementById('catsGrid');
  grid.innerHTML = '';
  if (!cats.length){
    document.getElementById('noData').style.display = 'block';
    return;
  }
  document.getElementById('noData').style.display = 'none';

  const packs = listPacks();
  cats.forEach(cat => {
    const card = document.createElement('div');
    card.className = 'catCard card';
    if (selectedCats.includes(cat)) card.classList.add('active');

    const h = document.createElement('h3');
    h.textContent = cat;
    card.appendChild(h);

    const drop = document.createElement('div');
    drop.className = 'drop';

    const label = document.createElement('label');
    label.textContent = 'اختر الحزمة لهذه الفئة:';
    drop.appendChild(label);

    const select = document.createElement('select');
    const options = packsByCategory(cat);
    const counts = Object.create(null);
    listQuestions().forEach(q => { if((q.category||"غير مصنفة")===cat){ counts[q.pack] = (counts[q.pack]||0)+1; } });
    options.forEach(p => {
      const o = document.createElement('option');
      o.value = p.id;
      o.textContent = `حزمة: ${p.name} (عدد: ${counts[p.id]||0})`;
      select.appendChild(o);
    });
    select.value = (selectedPacks||{})[cat] || (options[0]?.id || '');
    select.onchange = () => { selectedPacks[cat] = select.value || ''; setSelectedPacks(selectedPacks); };

    drop.appendChild(select);
    card.appendChild(drop);

    card.onclick = (e) => {
      if (e.target === select) return;
      if (selectedCats.includes(cat)) {
        selectedCats = selectedCats.filter(c => c !== cat);
        card.classList.remove('active');
      } else {
        if (selectedCats.length >= 6) return;
        selectedCats.push(cat);
        card.classList.add('active');
        if (!selectedPacks[cat] && select.value) { selectedPacks[cat] = select.value; setSelectedPacks(selectedPacks); }
      }
      setSelectedCategories(selectedCats);
      document.getElementById('selCount').textContent = `${selectedCats.length}/6`;
      document.getElementById('startBtn').disabled = (selectedCats.length !== 6);
    };

    grid.appendChild(card);
  });

  document.getElementById('selCount').textContent = `${selectedCats.length||0}/6`;
  document.getElementById('startBtn').disabled = (selectedCats.length !== 6);
}

// ---- boot ----
window.addEventListener('DOMContentLoaded', async () => {
  await ensureSharedLoaded();
  // Prefill and bind team names
  const n = getTeamNames();
  const a = document.getElementById('teamAInput');
  const b = document.getElementById('teamBInput');
  if (a) a.value = n.teamA || 'الفريق 1';
  if (b) b.value = n.teamB || 'الفريق 2';
  if (a) a.addEventListener('input', () => setTeamNames({ teamA: a.value, teamB: (document.getElementById('teamBInput')||{}).value || '' }));
  if (b) b.addEventListener('input', () => setTeamNames({ teamA: (document.getElementById('teamAInput')||{}).value || '', teamB: b.value }));

  renderSetup();

  const start = document.getElementById('startBtn');
  if (start) start.onclick = (e) => {
    try { e.preventDefault(); } catch {}
    if (!selectedCats || selectedCats.length !== 6) return;
    window.location.href = '/board.html';
  };
});
</script>
</body></html>
