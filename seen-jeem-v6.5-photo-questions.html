<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>سين جيم — v6.5 (صور كبيرة داخل الأسئلة)</title>
  <style>
    :root{
      --bg:#0b1021; --panel:#111936; --muted:#1c254b; --ink:#f1f5f9; --sub:#94a3b8; --brand:#6366f1; --ok:#22c55e; --danger:#ef4444; --warn:#eab308;
      --rad:18px; --pad:16px; --shadow:0 10px 35px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 800px at 80% -10%, rgba(99,102,241,.25), transparent 60%),
      radial-gradient(900px 700px at 10% -10%, rgba(34,197,94,.18), transparent 50%),
      var(--bg);
      color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    }
    .container{max-width:1350px;margin-inline:auto;padding:20px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(22px, 3.2vw, 32px)}
    .sub{color:var(--sub);font-size:14px}
    .btn{background:var(--muted);color:var(--ink);border:1px solid #2b3469;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;box-shadow:0 1px 0 #000 inset}
    .btn:hover{filter:brightness(1.07)}
    .btn.brand{background:var(--brand);border-color:#545bf0}
    .btn.green{background:#15803d;border-color:#166534}
    .btn.red{background:#b91c1c;border-color:#991b1b}
    .btn.warn{background:#b45309;border-color:#92400e}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), transparent), var(--panel);border:1px solid #20284f;border-radius:var(--rad);padding:var(--pad);box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, select, textarea{background:#0b122b;border:1px solid #2b3469;color:var(--ink);border-radius:10px;padding:8px 10px;outline:none;min-height:38px}
    input[type="number"]{width:110px} textarea{min-height:78px}
    .team{display:flex;align-items:center;justify-content:space-between;background:rgba(148,163,184,.08);border:1px solid #273266;border-radius:14px;padding:8px}
    .score{font-size:22px;font-weight:800;min-width:3ch;text-align:center}
    .board{margin-top:16px}
    .cat{font-weight:700;color:#cbd5e1;text-align:center;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center}
    .catPic{width:86px;height:52px;border-radius:14px;border:1px solid #2a356b;background:#0b1021 center/cover no-repeat;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
    .tile{height:70px;display:flex;align-items:center;justify-content:center;border-radius:22px;font-size:24px;font-weight:900;border:1px solid #4f58e5;background:linear-gradient(180deg, rgba(255,255,255,.05), transparent), #4f46e5;cursor:pointer;transition:.15s}
    .tile:hover{transform:translateY(-1px)} .tile.used{background:#0b1020;border-color:#1e2740;color:#475569;cursor:not-allowed;transform:none}
    .ghost{height:70px;border-radius:22px;border:1px dashed #334155;background:transparent}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2b3469;border-radius:999px;background:rgba(148,163,184,.08)}
    .chip .thumb{width:22px;height:22px;border-radius:6px;background:#0b1021 center/cover no-repeat;border:1px solid #293162}
    .errorbar{position:sticky;top:0;background:#7f1d1d;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid #991b1b;margin-bottom:10px;display:none;z-index:9999}
    .okbar{position:sticky;top:0;background:#064e3b;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid #065f46;margin-bottom:10px;display:none;z-index:9999}
    .spacer{height:8px}
    .catRow{display:grid;grid-template-columns: auto auto 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #273266;border-radius:12px;background:rgba(148,163,184,.05)}
    .catRow .thumb{width:32px;height:32px;border-radius:8px;background:#0b1021 center/cover no-repeat;border:1px solid #293162}
    .tag{font-size:12px;opacity:.8;margin-inline-start:.5ch}
    @media (min-width: 980px){ .twocol{grid-template-columns:1fr 1fr} .threecol{grid-template-columns:2fr 1fr} }
    #admin{display:none}
    .list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
    .list button{justify-content:space-between}
    .mini{font-size:12px;opacity:.8}
    .fieldset{border:1px dashed #334155;border-radius:12px;padding:10px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin-bottom:8px}
    .fx-star { pointer-events: none !important; }
    .catSettings{margin-top:10px;border-top:1px dashed #2c3569;padding-top:10px}
    .banner{display:flex;align-items:center;gap:10px}
    .banner .bannerPic{width:60px;height:60px;border-radius:12px;background:#0b1021 center/cover no-repeat;border:1px solid #2a356b}
    .results{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px,1fr));gap:10px}
    .resultCard{border:1px solid #2a356b;border-radius:10px;overflow:hidden;background:#0b1021}
    .resultCard img{width:100%;height:90px;object-fit:cover;display:block}
    .resultCard .meta{padding:6px;font-size:12px;color:#94a3b8;display:flex;align-items:center;justify-content:space-between}
    /* Question image big view */
    #qImgWrap{margin-top:12px; display:none}
    #qImg{width:100%; max-height:55vh; object-fit:contain; background:#0b1021; border-radius:12px; border:1px solid #273266}
  </style>
</head>
<body>
  <div class="container">
    <div id="errorBar" class="errorbar"></div>
    <div id="okBar" class="okbar"></div>
    <header>
      <div>
        <h1 id="boardTitle">سين جيم — v6.5</h1>
        <div class="sub">يمكنك الآن وضع <b>صور كبيرة</b> داخل الأسئلة نفسها (رابط أو رفع من جهازك). الترتيب: 100,100,200,200,300,300.</div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn brand" id="btnShowSetup">إعداد اللعبة</button>
          <button class="btn" id="btnNextGame">اللعبة التالية (تدوير الحِزم)</button>
          <button class="btn" id="btnReset">تصفير الأسئلة فقط</button>
          <button class="btn" id="btnManage">إدارة الأسئلة</button>
          <button class="btn" id="btnClickFix">🔓 إصلاح النقر</button>
          <button class="btn" id="btnTest">اختبار النقر</button>
        </div>
      </div>
      <div class="panel">
        <strong>التحكم السريع</strong>
        <div class="grid" style="gap:10px;margin-top:10px">
          <div class="row">
            <label class="sub">مدة الفريق الحالي</label>
            <input type="number" id="inpPrimary" value="60" min="5" step="5" />
            <label class="sub">مدة الفرصة</label>
            <input type="number" id="inpSteal" value="10" min="5" step="5" />
          </div>
          <div class="row">
            <label class="sub">عنوان اللوحة</label>
            <input id="inpTitle" value="سين جيم — نسخة خفيفة" />
          </div>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="chkAutoTurn" checked />
            <span>تدوير الدور تلقائيًا بعد كل سؤال</span>
          </label>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="chkConfetti" checked />
            <span>مؤثر احتفالي عند الإجابة الصحيحة</span>
          </label>
          <div class="panel" style="padding:10px">
            <div class="sub" style="margin-bottom:6px">الفئات المختارة لهذه اللعبة</div>
            <div id="selectedCatsView" class="grid" style="gap:8px"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Setup -->
    <section id="setup" class="panel" style="margin-top:12px;display:none">
      <h3 style="margin:0 0 6px 0">إعداد لعبة جديدة</h3>
      <div class="sub">اختر عدد الفئات، ثم حدّد الفئات وحِزمة كل فئة.</div>
      <div class="row" style="margin-top:10px">
        <label class="sub">عدد الفئات</label>
        <input type="number" id="numCats" min="3" max="10" value="6" />
        <button class="btn" id="btnRandCats">اختيار عشوائي</button>
        <button class="btn brand" id="btnStartGame">ابدأ اللعبة</button>
      </div>
      <div id="catsChecklist" class="grid" style="gap:10px;margin-top:10px"></div>
    </section>

    <!-- Admin Manager -->
    <section id="admin" class="panel" style="margin-top:12px;display:none">
      <h3 style="margin:0 0 6px">إدارة الفئات والحِزم والأسئلة</h3>
      <div class="sub">أضف/عدّل الفئات والحِزم، وحرّر أسئلة كل حزمة. لكل سؤال، يمكنك الآن إضافة صورة كبيرة.</div>
      <div class="grid" style="grid-template-columns: 1fr 1fr 2fr; gap:14px; margin-top:10px">
        <!-- Categories -->
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <strong>الفئات</strong>
            <div class="row">
              <button class="btn" id="btnAddCat">+ فئة</button>
              <button class="btn" id="btnRenameCat">إعادة تسمية</button>
              <button class="btn red" id="btnDeleteCat">حذف</button>
            </div>
          </div>
          <div id="catList" class="list" style="margin-top:8px"></div>
        </div>
        <!-- Packs -->
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <strong>الحِزم</strong>
            <div class="row">
              <button class="btn" id="btnAddPack">+ حزمة</button>
              <button class="btn" id="btnDupPack">نسخ</button>
              <button class="btn red" id="btnDelPack">حذف</button>
            </div>
          </div>
          <div id="packList" class="list" style="margin-top:8px"></div>
        </div>
        <!-- Editor / Category settings -->
        <div class="panel">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <strong id="editorTitle">المحرّر</strong>
              <div class="sub" id="editorSub"></div>
            </div>
            <div class="row">
              <button class="btn" id="btnExport">تصدير</button>
              <label class="btn" id="lblImport">
                استيراد (إضافة)
                <input type="file" id="fileImport" accept=".json" style="display:none">
              </label>
            </div>
          </div>

          <!-- Category picture tools (as before) -->
          <div class="banner catSettings">
            <div class="bannerPic" id="catPreview"></div>
            <div class="grid" style="gap:8px;flex:1">
              <div class="kv">
                <label>صورة الفئة (رابط)</label>
                <input id="catImgUrl" placeholder="https://example.com/pic.jpg" />
              </div>
              <div class="row">
                <label class="btn">
                  رفع صورة<input type="file" id="catImgFile" accept="image/*" style="display:none">
                </label>
                <button class="btn" id="btnAutoCatImg">تلقائي</button>
                <button class="btn" id="btnSaveCatImg">حفظ الصورة</button>
                <button class="btn red" id="btnClearCatImg">حذف الصورة</button>
              </div>
              <div class="sub">يمكنك أيضًا البحث عن صور بالأسفل (Unsplash / Pixabay).</div>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <strong>بحث عن صورة للفئة</strong>
            <div class="grid" style="gap:8px;margin-top:8px">
              <div class="row">
                <label>المزوّد</label>
                <select id="imgProvider">
                  <option value="unsplash">Unsplash</option>
                  <option value="pixabay">Pixabay</option>
                </select>
                <input id="imgQuery" placeholder="مثال: جغرافيا، تاريخ، رياضة..." style="flex:1" />
                <button class="btn" id="btnSearchImg">بحث</button>
              </div>
              <div class="row">
                <input id="unsplashKey" placeholder="Unsplash Access Key" style="flex:1" />
                <input id="pixabayKey" placeholder="Pixabay API Key" style="flex:1" />
                <button class="btn" id="btnSaveKeys">حفظ المفاتيح</button>
              </div>
              <div class="sub">المفاتيح تُخزَّن محليًا فقط في المتصفح.</div>
              <div id="imgResults" class="results"></div>
            </div>
          </div>

          <div id="packEditor" style="margin-top:10px"></div>
          <div class="row" style="margin-top:8px;justify-content:flex-end">
            <button class="btn green" id="btnSaveAll">حفظ الكل</button>
            <button class="btn" id="btnCloseAdmin">إغلاق الإدارة</button>
          </div>
        </div>
      </div>
    </section>

    <section class="grid twocol" style="margin-top:12px">
      <div class="panel">
        <div class="row" style="justify-content:space-between;margin-bottom:10px">
          <strong>الفرق و النقاط</strong>
          <div class="row">
            <button class="btn" id="btnAddTeam">إضافة فريق</button>
            <button class="btn red" id="btnZeroScores">تصفير النقاط</button>
          </div>
        </div>
        <div id="teams" class="grid" style="gap:10px"></div>
        <div class="sub">يُدار الدور تلقائيًا بعد كل سؤال (يمكن تعطيله)، ويمكنك تغييره يدويًا هنا.</div>
      </div>

      <div class="panel board">
        <div id="board"></div>
        <!-- Inline question drawer -->
        <div id="qDrawer" class="panel" style="margin-top:14px; display:none; border-color:#1f453b;background:linear-gradient(180deg, rgba(34,197,94,.08), transparent)">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="row" style="gap:10px;align-items:center">
              <div class="bannerPic" id="qCatPic" style="width:48px;height:48px"></div>
              <div>
                <div class="sub"><span id="qCat"></span> — <span id="qPts"></span> نقطة <span id="packTag" class="tag"></span> <span id="qSubIdx" class="tag"></span></div>
                <h3 id="qTitle" style="margin:4px 0 0 0"></h3>
              </div>
            </div>
            <button class="btn" id="btnCloseQ">إغلاق</button>
          </div>

          <!-- BIG image for question -->
          <div id="qImgWrap">
            <img id="qImg" alt="صورة السؤال" />
          </div>

          <div id="qOptions" class="grid" style="gap:10px;margin-top:10px"></div>

          <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
            <span class="chip" id="phaseChip">الدور: —</span>
            <span class="chip">الوقت: <b id="tLeft">60</b>s</span>
            <button class="btn" id="btnForceSteal">تحويل إلى فرصة 10 ثوانٍ</button>
            <div class="row" style="margin-inline-start:auto;gap:8px">
              <button class="btn" id="btnPause">إيقاف/تشغيل</button>
              <button class="btn" id="btnResetTimer">تصفير المؤقت</button>
            </div>
          </div>

          <div id="answerWrap" class="panel" style="margin-top:10px;display:none">
            <div class="sub">الإجابة الصحيحة</div>
            <div id="qAnswer" style="font-size:22px;font-weight:800;margin-top:6px"></div>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="sub" style="margin-bottom:6px">وسائل مساعدة</div>
            <div id="lifelinesArea" class="grid" style="gap:8px"></div>
          </div>

          <div class="row" style="gap:10px;margin-top:10px">
            <button class="btn" id="btnHint" style="display:none">تلميح</button>
            <button class="btn" id="btnReveal">إظهار الإجابة</button>
            <button class="btn warn" id="btnNoOne" style="margin-inline-start:auto">لا أحد أجاب — إغلاق السؤال</button>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="sub" style="margin-bottom:6px">اختر الفريق الذي أجاب إجابة صحيحة</div>
            <div id="awardBtns" class="row" style="flex-wrap:wrap;gap:8px"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const showError = (msg, err) => {
    const bar = document.getElementById("errorBar");
    bar.textContent = "⚠️ " + msg + (err? " — " + (err.message||err): "");
    bar.style.display = "block";
    setTimeout(()=> bar.style.display="none", 5000);
    console.error(msg, err);
  };
  const showOk = (msg) => {
    const bar = document.getElementById("okBar");
    bar.textContent = "✅ " + msg;
    bar.style.display = "block";
    setTimeout(()=> bar.style.display="none", 2500);
  };

  window.addEventListener("error", (e)=>{
    const bar = document.getElementById("errorBar");
    if (bar){ bar.textContent = "⚠️ خطأ في السكربت: " + (e.message||e); bar.style.display="block"; }
  });

  try {
    // ==== Safe storage ====
    const store = (()=>{ try{ const k="__t__"+Math.random(); localStorage.setItem(k,"1"); localStorage.removeItem(k); return localStorage; } catch{ const mem={}; return { getItem:(k)=>k in mem?mem[k]:null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:(k)=>{delete mem[k]} }; } })();

    // ==== Utilities ====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,10);
    const shuffle = (arr) => { const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const escapeHtml = (str) => String(str).replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    const deepClone = (o) => JSON.parse(JSON.stringify(o));

    // ==== Auto category cover (same as v6.4) ====
    function emojiForCategory(name){
      const s = (name||"").toLowerCase();
      const rules = [
        {k:"جغراف", e:"🌍"}, {k:"تاريخ", e:"🏛️"}, {k:"علوم", e:"🧪"}, {k:"رياض", e:"⚽"},
        {k:"فن", e:"🎨"}, {k:"تقن", e:"💻"}, {k:"تكنولوج", e:"💻"}, {k:"أدب", e:"📚"},
        {k:"لغة", e:"🗣️"}, {k:"دين", e:"🕌"}, {k:"قرآن", e:"🕌"}, {k:"أفلام", e:"🎬"},
        {k:"مسلس", e:"🎬"}, {k:"سينما", e:"🎬"}, {k:"موسي", e:"🎵"}, {k:"طبي", e:"🌿"},
        {k:"حاسوب", e:"💻"}, {k:"رياضيات", e:"➗"}, {k:"كيمي", e:"🧪"}, {k:"فيزي", e:"⚛️"},
        {k:"حيوان", e:"🐾"}, {k:"طعام", e:"🍽️"}, {k:"ثقاف", e:"🧭"}, {k:"معلومات", e:"🧠"}
      ];
      const hit = rules.find(r=> s.includes(r.k) );
      return hit? hit.e : "🧩";
    }
    function coverDataUrl(cat){
      const name = String(cat||"").trim();
      const emoji = emojiForCategory(name);
      let h = 0; for (let ch of name){ h = (h*33 + ch.codePointAt(0)) >>> 0; }
      const h1 = h % 360, h2 = (h + 90) % 360;
      const c1 = `hsl(${h1},70%,45%)`, c2 = `hsl(${h2},70%,35%)`;
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 360'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop offset='0%' stop-color='${c1}'/><stop offset='100%' stop-color='${c2}'/>
        </linearGradient></defs>
        <rect width='600' height='360' fill='url(#g)'/>
        <text x='50%' y='55%' font-size='160' text-anchor='middle' dominant-baseline='middle'>${emoji}</text>
        <text x='50%' y='92%' font-size='44' text-anchor='middle' fill='rgba(255,255,255,.9)'>${name}</text>
      </svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    // ==== Data ====
    let PACKS = JSON.parse(store.getItem("sj_packs_v6_5")||"null")?.packs ||
                JSON.parse(store.getItem("sj_packs_v6_4")||"null")?.packs ||
                JSON.parse(store.getItem("sj_packs_v6_3_admin")||"null")?.packs || null;
    if(!PACKS){
      PACKS = {"ثقافة عامة":[{100:[{type:"open",text:"ما هي عاصمة السعودية؟",answer:"الرياض"},{type:"open",text:"",answer:""}],200:[{type:"open",text:"كم عدد أيام الأسبوع؟",answer:"سبعة أيام"},{type:"open",text:"",answer:""}],300:[{type:"open",text:"أي كوكب يُعرف بالكوكب الأحمر؟",answer:"المريخ"},{type:"open",text:"",answer:""}],400:{type:"open",text:"ما هو أكبر محيط على الأرض؟",answer:"المحيط الهادئ"}}]};
    }
    let META = JSON.parse(store.getItem("sj_meta_v6_5") || "null") || {};
    Object.keys(PACKS).forEach(cat=>{ META[cat] = META[cat] || {}; if (!META[cat].img) META[cat].img = coverDataUrl(cat); });

    let API = JSON.parse(store.getItem("sj_api_keys_v6_5") || "null") || {unsplash:"", pixabay:""};

    const LS = {
      packs: "sj_packs_v6_5",
      packIndex: "sj_packIndex_v6_5",
      used: "sj_used_v6_5",
      teams: "sj_teams_v6_5",
      settings: "sj_settings_v6_5",
      selectedCats: "sj_selectedCats_v6_5",
      numCats: "sj_numCats_v6_5",
      activeTeam: "sj_activeTeam_v6_5",
      lifelines: "sj_lifelines_v6_5",
      meta: "sj_meta_v6_5",
      api: "sj_api_keys_v6_5"
    };

    if (!store.getItem(LS.packs)) { store.setItem(LS.packs, JSON.stringify({packs: PACKS})); }
    if (!store.getItem(LS.meta)) { store.setItem(LS.meta, JSON.stringify(META)); }
    if (!store.getItem(LS.api)) { store.setItem(LS.api, JSON.stringify(API)); }

    // ==== Points order ====
    const DISPLAY = [ {pts:100, idx:0}, {pts:100, idx:1}, {pts:200, idx:0}, {pts:200, idx:1}, {pts:300, idx:0}, {pts:300, idx:1} ];

    // ==== DOM ====
    const boardEl = $("#board"); const teamsEl = $("#teams");
    const btnAddTeam = $("#btnAddTeam"); const btnZeroScores = $("#btnZeroScores");
    const btnReset = $("#btnReset"); const btnNextGame = $("#btnNextGame");
    const btnShowSetup = $("#btnShowSetup"); const inpTitle = $("#inpTitle");
    const chkConfetti = $("#chkConfetti"); const boardTitle = $("#boardTitle");
    const selectedCatsView = $("#selectedCatsView");
    const inpPrimary = $("#inpPrimary"); const inpSteal = $("#inpSteal"); const chkAutoTurn = $("#chkAutoTurn");
    const btnManage = $("#btnManage"); const okBar = $("#okBar"); const btnClickFix = $("#btnClickFix");

    const setup = $("#setup"); const numCats = $("#numCats");
    const catsChecklist = $("#catsChecklist"); const btnStartGame = $("#btnStartGame"); const btnRandCats = $("#btnRandCats");

    const admin = $("#admin"); const btnAddCat = $("#btnAddCat"); const btnRenameCat = $("#btnRenameCat"); const btnDeleteCat = $("#btnDeleteCat");
    const btnAddPack = $("#btnAddPack"); const btnDupPack = $("#btnDupPack"); const btnDelPack = $("#btnDelPack");
    const catList = $("#catList"); const packList = $("#packList");
    const packEditor = $("#packEditor"); const editorTitle = $("#editorTitle"); const editorSub = $("#editorSub");
    const btnExport = $("#btnExport"); const fileImport = $("#fileImport"); const btnSaveAll = $("#btnSaveAll"); const btnCloseAdmin = $("#btnCloseAdmin"); const lblImport = $("#lblImport");
    const catPreview = $("#catPreview"); const catImgUrl = $("#catImgUrl"); const catImgFile = $("#catImgFile"); const btnSaveCatImg = $("#btnSaveCatImg"); const btnClearCatImg = $("#btnClearCatImg"); const btnAutoCatImg = $("#btnAutoCatImg");
    const imgProvider = $("#imgProvider"); const imgQuery = $("#imgQuery"); const btnSearchImg = $("#btnSearchImg"); const imgResults = $("#imgResults");
    const unsplashKey = $("#unsplashKey"); const pixabayKey = $("#pixabayKey"); const btnSaveKeys = $("#btnSaveKeys");

    const qDrawer = $("#qDrawer"); const qCat = $("#qCat"); const qPts = $("#qPts"); const qTitle = $("#qTitle"); const qOptions = $("#qOptions"); const qAnswer = $("#qAnswer");
    const answerWrap = $("#answerWrap"); const awardBtns = $("#awardBtns"); const btnNoOne = $("#btnNoOne"); const btnCloseQ = $("#btnCloseQ");
    const tLeft = $("#tLeft"); const btnPause = $("#btnPause"); const btnResetTimer = $("#btnResetTimer"); const btnReveal = $("#btnReveal"); const btnHint = $("#btnHint"); const btnForceSteal = $("#btnForceSteal");
    const phaseChip = $("#phaseChip"); const packTag = $("#packTag"); const lifelinesArea = $("#lifelinesArea"); const qCatPic = $("#qCatPic"); const qSubIdx = $("#qSubIdx");
    const qImgWrap = $("#qImgWrap"); const qImg = $("#qImg");

    // ==== State ====
    let packIndexByCat = JSON.parse(store.getItem(LS.packIndex) || "null") || {};
    let usedMap = JSON.parse(store.getItem(LS.used) || "null") || {};
    let teams = JSON.parse(store.getItem(LS.teams) || "null") || [ {id:uid(),name:"فريق ١",score:0}, {id:uid(),name:"فريق ٢",score:0} ];
    let settings = JSON.parse(store.getItem(LS.settings) || "null") || { primarySec:60, stealSec:10, boardTitle:"سين جيم — نسخة خفيفة", showConfetti:true, autoTurn:true };
    let selectedCats = JSON.parse(store.getItem(LS.selectedCats) || "null") || null;
    let selectedNum = Number(store.getItem(LS.numCats) || "6") || 6;
    let activeTeamId = JSON.parse(store.getItem(LS.activeTeam) || "null") || (teams[0] && teams[0].id);
    let lifelinesUsed = JSON.parse(store.getItem(LS.lifelines) || "null") || {};

    const ensureLife = (id)=>{ lifelinesUsed[id] = lifelinesUsed[id] || {steal:false,time:false,double:false,two:false}; return lifelinesUsed[id]; };
    const saveLife = ()=> store.setItem(LS.lifelines, JSON.stringify(lifelinesUsed));
    const savePacks = ()=> store.setItem(LS.packs, JSON.stringify({packs: PACKS}));
    const saveMeta = ()=> store.setItem(LS.meta, JSON.stringify(META));
    const saveAPI = ()=> store.setItem(LS.api, JSON.stringify(API));
    const saveActiveTeam = ()=> store.setItem(LS.activeTeam, JSON.stringify(activeTeamId));

    // ==== Helpers ====
    const categories = () => Object.keys(PACKS);
    const activeCategories = () => (selectedCats && selectedCats.length) ? selectedCats : categories().slice(0, Math.min(selectedNum, categories().length));
    const packCount = (cat) => (PACKS[cat] || []).length || 0;
    const currentPackIndex = (cat) => {
      const n = packCount(cat); if (!(cat in packIndexByCat)) packIndexByCat[cat] = 0;
      if (n === 0) return 0;
      if (packIndexByCat[cat] > n-1 || packIndexByCat[cat] < 0 || Number.isNaN(packIndexByCat[cat])) packIndexByCat[cat] = 0;
      return packIndexByCat[cat];
    };
    const keyFor = (cat, pack, pts, idx) => `${cat}|${pack}|${pts}|${idx}`;
    const catImg = (cat)=> (META[cat]?.img || coverDataUrl(cat));

    // ==== Render ====
    function renderSelectedCatsView(){
      const cats = activeCategories();
      selectedCatsView.innerHTML = cats.map(c=>{
        const img = catImg(c);
        return `<span class="chip"><span class="thumb" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></span>${escapeHtml(c)} <span class="tag">ح${currentPackIndex(c)+1}</span></span>`;
      }).join(" ");
    }

    function renderBoard(){
      const cats = activeCategories();
      const cols = `grid-template-columns: repeat(${cats.length}, minmax(0,1fr))`;
      let html = `<div class="grid" style="${cols}">` + cats.map(c=>{
        const img = catImg(c);
        return `<div class="cat">
          <div class="catPic" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></div>
          <div>${escapeHtml(c)} <span class="tag">ح${currentPackIndex(c)+1}</span></div>
        </div>`;
      }).join("") + `</div>`;
      html += `<div class="grid" style="gap:14px;${cols}">`;
      for(const row of DISPLAY){
        for(const c of cats){
          const pidx = currentPackIndex(c);
          const pack = PACKS[c] && PACKS[c][pidx];
          const arr = pack && pack[row.pts];
          const q = Array.isArray(arr) ? arr[row.idx] : (row.idx===0 ? arr : null);
          const hasText = q && ((q.text||"").trim().length>0 || (q.img||"").trim().length>0);
          if(!q || !hasText){ html += `<div class="ghost"></div>`; continue; }
          const used = !!usedMap[keyFor(c, pidx, row.pts, row.idx)];
          html += `<button class="${used?'tile used':'tile'}" data-cat="${c}" data-pts="${row.pts}" data-sub="${row.idx}" title="${escapeHtml(q.text||'')}">${row.pts}</button>`;
        }
      }
      html += `</div>`;
      boardEl.innerHTML = html;
      $$(".tile", boardEl).forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          const cat = ev.currentTarget.getAttribute("data-cat");
          const pts = Number(ev.currentTarget.getAttribute("data-pts"));
          const sub = Number(ev.currentTarget.getAttribute("data-sub"));
          const pidx = currentPackIndex(cat);
          const arr = PACKS[cat]?.[pidx]?.[pts];
          const q = Array.isArray(arr)? arr[sub] : (sub===0? arr : null);
          if(!q || usedMap[keyFor(cat,pidx,pts,sub)] || (!((q.text||"").trim().length>0 || (q.img||"").trim().length>0))) return;
          openQuestion(cat, pts, q, pidx, sub);
        });
      });
    }

    function renderTeams(){
      teamsEl.innerHTML = teams.map(t=>{
        const life = ensureLife(t.id);
        const lifeIcons = `<span class="mini">س:${life.steal?"✅":"—"} ز:${life.time?"✅":"—"} م:${life.double?"✅":"—"} ٢:${life.two?"✅":"—"}</span>`;
        return `<div class="team">
          <div class="row" style="gap:8px;align-items:center">
            <input type="radio" name="turn" class="activePick" ${t.id===activeTeamId?"checked":""} data-id="${t.id}" title="الدور الحالي" />
            <input value="${escapeHtml(t.name||'')}" data-id="${t.id}" class="teamName" style="width:160px"/>
            <div class="sub" style="font-size:12px">${lifeIcons}</div>
          </div>
          <div class="row">
            <button class="btn" data-id="${t.id}" data-delta="-50">-50</button>
            <span class="score">${t.score}</span>
            <button class="btn" data-id="${t.id}" data-delta="50">+50</button>
            <button class="btn red" data-remove="${t.id}">حذف</button>
          </div>
        </div>`;
      }).join("");

      $$(".activePick", teamsEl).forEach(inp=>{
        inp.addEventListener("change", (e)=>{ activeTeamId = e.target.getAttribute("data-id"); saveActiveTeam(); });
      });
      $$(".teamName", teamsEl).forEach(inp=>{
        inp.addEventListener("input", (e)=>{ const id = e.target.getAttribute("data-id"); const val = e.target.value; teams = teams.map(t=>t.id===id?{...t,name:val}:t); store.setItem(LS.teams, JSON.stringify(teams)); });
      });
      $$("[data-delta]", teamsEl).forEach(btn=>{
        btn.addEventListener("click", (e)=>{ const id = e.currentTarget.getAttribute("data-id"); const d = Number(e.currentTarget.getAttribute("data-delta")); teams = teams.map(t=>t.id===id?{...t,score:t.score + d}:t); store.setItem(LS.teams, JSON.stringify(teams)); renderTeams(); });
      });
      $$("[data-remove]", teamsEl).forEach(btn=>{
        btn.addEventListener("click", (e)=>{ const id = e.currentTarget.getAttribute("data-remove"); teams = teams.filter(t=>t.id!==id); if (activeTeamId===id) activeTeamId = teams[0]?.id; store.setItem(LS.teams, JSON.stringify(teams)); saveActiveTeam(); renderTeams(); });
      });
    }

    // ==== Question drawer & timing ====
    let current = {cat:null, pts:null, pack:null, sub:0};
    let timerInt = null;
    let phase = "idle"; // "primary" | "steal" | "done"
    let primaryTeamId = null, stealTeamId = null;
    let doubleForTeam = null;
    let twoAnswersTeam = null; let twoLeft = 0;

    function setSeconds(s){ tLeft.textContent = Math.max(0, s); tLeft.dataset.val = String(Math.max(0,s)); }
    function startTick(){
      stopTick();
      timerInt = setInterval(()=>{
        let s = Number(tLeft.dataset.val||"0");
        if (s>0){ setSeconds(s-1); }
        else {
          if (phase === "primary"){
            if (stealTeamId){ startStealPhase(); } else { phase = "done"; stopTick(); }
          } else if (phase === "steal"){ phase = "done"; stopTick(); }
        }
      }, 1000);
    }
    function stopTick(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }

    function startPrimaryPhase(){
      phase = "primary";
      phaseChip.textContent = `الدور: ${teamName(primaryTeamId)} — (${settings.primarySec||60} ث)`;
      setSeconds(settings.primarySec||60);
      startTick();
      renderLifelines();
    }
    function startStealPhase(){
      phase = "steal";
      phaseChip.textContent = `فرصة/سرقة: ${teamName(stealTeamId)} — (${settings.stealSec||10} ث)`;
      setSeconds(settings.stealSec||10);
      startTick();
      renderLifelines();
    }

    function teamName(id){ const t = teams.find(x=>x.id===id); return t? t.name : "—"; }
    function nextTeamId(id){
      if (!teams.length) return null;
      const idx = Math.max(0, teams.findIndex(t=>t.id===id));
      return teams[(idx+1) % teams.length]?.id || null;
    }

    function openQuestion(cat, pts, q, pidx, sub){
      current = {cat, pts, pack:pidx, sub};
      qCat.textContent = cat; qPts.textContent = pts; qTitle.textContent = q.text || "";
      qAnswer.textContent = q.answer || ""; answerWrap.style.display="none"; btnReveal.textContent="إظهار الإجابة";
      btnHint.style.display = q.hint? "inline-block":"none";
      packTag.textContent = `(ح${pidx+1})`; qSubIdx.textContent = sub===0? "(أ)" : "(ب)";
      qCatPic.style.backgroundImage = `url('${(catImg(cat)||'').replace(/'/g,"%27")}')`;

      // BIG image
      if (q.img && q.img.trim()){
        qImg.src = q.img;
        qImgWrap.style.display = "block";
      } else {
        qImg.removeAttribute("src");
        qImgWrap.style.display = "none";
      }

      qOptions.innerHTML = "";
      if(q.type==="mcq" && q.options){
        q.options.forEach((opt,i)=>{
          const b = document.createElement("button");
          b.className = "btn"; b.style.width="100%"; b.textContent = String.fromCharCode(0x0627+i) + ". " + opt;
          qOptions.appendChild(b);
        });
      }

      awardBtns.innerHTML = teams.map(t=>`<button class="btn green" data-award="${t.id}">${escapeHtml(t.name||'')}</button>`).join("");
      $$("[data-award]", awardBtns).forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const id = e.currentTarget.getAttribute("data-award");
          const idx = teams.findIndex(t=>t.id===id);
          if(idx>=0){
            const multiplier = (doubleForTeam && id===doubleForTeam) ? 2 : 1;
            teams[idx] = {...teams[idx], score: teams[idx].score + current.pts * multiplier};
            store.setItem(LS.teams, JSON.stringify(teams)); renderTeams();
          }
          const prevPrimary = primaryTeamId;
          markUsed(current.cat, current.pack, current.pts, current.sub);
          if(settings.showConfetti) confetti();
          stopTick(); closeQuestion();
          advanceTurnAfterQuestion(prevPrimary);
        });
      });

      doubleForTeam = null; twoAnswersTeam = null; twoLeft = 0;

      primaryTeamId = activeTeamId || (teams[0] && teams[0].id);
      stealTeamId = nextTeamId(primaryTeamId);
      startPrimaryPhase();

      qDrawer.style.display = "block";
      qDrawer.scrollIntoView({behavior:"smooth", block:"center"});
    }
    function closeQuestion(){ qDrawer.style.display = "none"; phase="idle"; stopTick(); }

    function markUsed(cat, pidx, pts, sub){ usedMap[keyFor(cat, pidx, pts, sub)] = true; saveUsed(); renderBoard(); }
    function saveUsed(){ store.setItem(LS.used, JSON.stringify(usedMap)); }
    function advanceTurnAfterQuestion(prevPrimaryId){ if (!settings.autoTurn) return; const nxt = nextTeamId(prevPrimaryId); if (nxt){ activeTeamId = nxt; saveActiveTeam(); renderTeams(); } }

    // ==== Lifelines (same as v6.4) ====
    function renderLifelines(){
      const lifeFor = (teamId)=> ensureLife(teamId);
      const currentPhaseTeam = (phase==="primary") ? primaryTeamId : (phase==="steal" ? stealTeamId : null);

      let html = "";
      if (currentPhaseTeam){
        const L = lifeFor(currentPhaseTeam);
        html += `<div class="row" style="flex-wrap:wrap;gap:8px"><div class="sub">للفريق الحالي: <b>${escapeHtml(teamName(currentPhaseTeam)||'')}</b></div>`;
        html += `<button class="btn lifeline ${L.time?'used':''}" id="lifeAddTime" ${L.time?'disabled':''} title="زيادة الوقت +20 ثانية">+20 ثانية</button>`;
        html += `<button class="btn lifeline ${L.double?'used':''}" id="lifeDouble" ${L.double?'disabled':''} title="مضاعفة النقاط عند الفوز">مضاعفة النقاط</button>`;
        html += `<button class="btn lifeline ${L.two?'used':''}" id="lifeTwo" ${L.two?'disabled':''} title="سماح بمحاولتين">محاولتان</button>`;
        if (twoAnswersTeam===currentPhaseTeam){
          html += `<span class="chip">محاولات متبقية: <b id="twoLeft">${twoLeft}</b></span>
                   <button class="btn" id="btnWrongAttempt">تسجيل محاولة خاطئة</button>`;
        }
        html += `</div>`;
      }
      html += `<div class="panel" style="border-style:dashed">
        <div class="sub" style="margin-bottom:6px"><b>سرقة السؤال</b> — اختر فريقك أثناء وقت الفريق الأساسي (مرّة واحدة لكل فريق):</div>`;
      if (phase==="primary"){
        teams.filter(t=>t.id!==primaryTeamId).forEach(t=>{
          const L = lifeFor(t.id);
          html += `<button class="btn lifeline ${L.steal?'used':''}" data-steal="${t.id}" ${L.steal?'disabled':''} title="سرقة السؤال الآن (${settings.stealSec||10} ث)">${escapeHtml(t.name||'')}</button>`;
        });
      } else { html += `<span class="sub">السرقة متاحة فقط خلال وقت الفريق الأساسي.</span>`; }
      html += `</div>`;

      lifelinesArea.innerHTML = html;

      if (currentPhaseTeam){
        const L = ensureLife(currentPhaseTeam);
        const addTime = $("#lifeAddTime"); const dbl = $("#lifeDouble"); const two = $("#lifeTwo");
        if (addTime) addEvent(addTime, "click", ()=>{ if (L.time) return; setSeconds(Number(tLeft.dataset.val||"0") + 20); L.time = true; saveLife(); renderTeams(); renderLifelines(); });
        if (dbl) addEvent(dbl, "click", ()=>{ if (L.double) return; doubleForTeam = currentPhaseTeam; L.double = true; saveLife(); renderTeams(); renderLifelines(); });
        if (two) addEvent(two, "click", ()=>{ if (L.two) return; twoAnswersTeam = currentPhaseTeam; twoLeft = 1; L.two = true; saveLife(); renderTeams(); renderLifelines(); });
        const wrongBtn = $("#btnWrongAttempt");
        if (wrongBtn) addEvent(wrongBtn, "click", ()=>{ if (twoAnswersTeam===currentPhaseTeam && twoLeft>0){ twoLeft -= 1; const span=$("#twoLeft"); if(span) span.textContent = String(twoLeft); } });
      }
      $$("[data-steal]").forEach(btn=>{
        addEvent(btn, "click", (e)=>{
          const id = e.currentTarget.getAttribute("data-steal");
          const L = ensureLife(id);
          if (L.steal || phase!=="primary") return;
          L.steal = true; saveLife(); renderTeams();
          stealTeamId = id;
          startStealPhase();
        });
      });
    }
    function addEvent(node, type, handler){ try{ node.addEventListener(type, handler, false); }catch(e){ console.warn("Listener fail", e); } }

    // ==== Setup (inline) ====
    function openSetup(){ setup.style.display = setup.style.display==="none" ? "block" : "none"; if (setup.style.display==="block"){ populateChecklist(); } }
    function populateChecklist(){
      numCats.value = selectedNum;
      const all = categories();
      const chosen = new Set(activeCategories());
      catsChecklist.innerHTML = all.map(c=>{
        const count = packCount(c);
        const cur = currentPackIndex(c);
        const sel = Array.from({length: Math.max(1,count)}, (_,i)=>`<option value="${i}" ${i===cur?"selected":""}>حزمة ${i+1}</option>`).join("");
        const img = catImg(c);
        return `<div class="catRow">
          <span class="thumb" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></span>
          <label class="row" style="gap:8px"><input type="checkbox" class="catCheck" value="${c}" ${chosen.has(c)?"checked":""}/><span>${escapeHtml(c)}</span></label>
          <div></div>
          <select class="packPick" data-cat="${escapeHtml(c)}" ${chosen.has(c)?"":"disabled"}>${sel}</select>
        </div>`;
      }).join("");
      enforceNumSelection();
    }
    function getCheckedCats(){ return $$("input.catCheck", catsChecklist).filter(i=>i.checked).map(i=>i.value); }
    function enforceNumSelection(){
      selectedNum = Math.max(3, Math.min(10, Number(numCats.value)||6));
      const checks = $$("input.catCheck", catsChecklist);
      if (getCheckedCats().length > selectedNum){
        while(getCheckedCats().length > selectedNum){ const last = checks.reverse().find(i=>i.checked); if(last) last.checked = false; }
      }
      const atLimit = getCheckedCats().length >= selectedNum;
      checks.forEach(i=>{
        const cat = i.value; const picker = catsChecklist.querySelector(`.packPick[data-cat="${CSS.escape(cat)}"]`);
        if(!i.checked){ i.disabled = atLimit; if(picker){ picker.disabled = true; } }
        else { i.disabled = false; if(picker){ picker.disabled = false; } }
      });
      btnStartGame.disabled = (getCheckedCats().length !== selectedNum);
    }

    // ==== Admin Manager ====
    let adminCat = null;
    let adminPackIdx = 0;

    function defaultQ(){ return {type:"open", text:"", answer:"", hint:"", img:""}; }
    function defaultPack(){
      return { 100: [ defaultQ(), defaultQ() ], 200: [ defaultQ(), defaultQ() ], 300: [ defaultQ(), defaultQ() ], 400: defaultQ() };
    }
    function normalizeQ(q){
      return {
        type: (q && q.type==='mcq') ? 'mcq' : 'open',
        text: q && q.text || "",
        answer: q && q.answer || "",
        hint: q && q.hint || "",
        options: Array.isArray(q && q.options) ? q.options : (q && typeof q.options==='string'? q.options.split('|').map(s=>s.trim()).filter(Boolean): []),
        correct: Math.max(1, Number(q && q.correct)||1),
        img: q && q.img || ""
      };
    }
    function normalizePack(p){
      const np = defaultPack();
      [100,200,300].forEach(v=>{
        const val = p[v];
        if (Array.isArray(val)){
          np[v][0] = normalizeQ(val[0] || {});
          np[v][1] = normalizeQ(val[1] || {});
        } else if (val && typeof val === 'object'){
          np[v][0] = normalizeQ(val);
        }
      });
      if (p[400]){ if (Array.isArray(p[400])) np[400] = normalizeQ(p[400][0] || {}); else np[400] = normalizeQ(p[400]); }
      return np;
    }

    function openAdmin(){ admin.style.display = admin.style.display==="none" ? "block" : "none"; if (admin.style.display==="block"){ renderAdmin(); } }
    function renderAdmin(){
      if (!adminCat || !(adminCat in PACKS)){ adminCat = categories()[0] || null; adminPackIdx = 0; }
      // categories list
      catList.innerHTML = categories().map(c=>{
        const img = catImg(c);
        return `<button class="btn ${c===adminCat?'brand':''}" data-cat="${c}">
          <span class="thumb" style="width:22px;height:22px;border-radius:6px;background-image:url('${img?img.replace(/'/g,"%27"):''}');border:1px solid #2a356b"></span>
          ${escapeHtml(c)} <span class="mini">(${packCount(c)} حزمة)</span></button>`;
      }).join("");
      $$("[data-cat]", catList).forEach(btn=> btn.addEventListener("click", e=>{ adminCat = e.currentTarget.getAttribute("data-cat"); adminPackIdx = 0; renderAdmin(); }));
      // packs list
      const n = packCount(adminCat);
      let packBtns = n? "" : `<div class="sub">لا توجد حِزم في هذه الفئة.</div>`;
      for(let i=0;i<n;i++){ packBtns += `<button class="btn ${i===adminPackIdx?'brand':''}" data-pack="${i}">حزمة ${i+1}</button>`; }
      packList.innerHTML = packBtns;
      $$("[data-pack]", packList).forEach(btn=> btn.addEventListener("click", e=>{ adminPackIdx = Number(e.currentTarget.getAttribute("data-pack")); renderAdmin(); }));
      // editor
      editorTitle.textContent = adminCat ? `تحرير الحزمة — ${adminCat}` : "المحرّر";
      editorSub.textContent = (n>0) ? `حزمة ${adminPackIdx+1} من ${n}` : "أضف حزمة أولاً.";
      refreshCatSettings();
      renderPackEditor();
    }

    function refreshCatSettings(){
      if (!adminCat){ catPreview.style.backgroundImage=""; catImgUrl.value=""; return; }
      const img = META[adminCat]?.img || coverDataUrl(adminCat);
      catPreview.style.backgroundImage = img ? `url('${img.replace(/'/g,"%27")}')` : "";
      catImgUrl.value = META[adminCat]?.img || "";
    }

    function qBlock(q, label, key){
      const optBlock = `
        <div class="kv mc" style="display:${q.type==='mcq'?'grid':'none'}">
          <label>خيارات (|)</label>
          <textarea data-field="options-${key}" placeholder="مثال: خيار أ|خيار ب|خيار ج">${(q.options||[]).join('|')}</textarea>
        </div>
        <div class="kv mc" style="display:${q.type==='mcq'?'grid':'none'}">
          <label>الصح (#)</label>
          <input type="number" min="1" value="${(q.correct||1)}" data-field="correct-${key}" />
        </div>`;
      const imgBlock = `
        <div class="kv">
          <label>صورة للسؤال (رابط)</label>
          <input data-field="img-${key}" value="${q.img||''}" placeholder="https://... أو يُملأ تلقائيًا عند الرفع"/>
        </div>
        <div class="row">
          <label class="btn">
            رفع صورة<input type="file" accept="image/*" data-upload="img-${key}" style="display:none">
          </label>
          <button class="btn red" data-clear="img-${key}">حذف الصورة</button>
        </div>
        <div class="row"><img data-preview="img-${key}" style="max-width:100%; max-height:120px; border-radius:8px; border:1px solid #2b3469; display:${q.img?'block':'none'}" src="${q.img||''}"></div>
      `;
      return `
        <div class="fieldset">
          <div class="row" style="justify-content:space-between;align-items:center"><strong>${label}</strong></div>
          <div class="kv">
            <label>النوع</label>
            <select data-field="type-${key}">
              <option value="open" ${q.type!=='mcq'?'selected':''}>سؤال مفتوح</option>
              <option value="mcq" ${q.type==='mcq'?'selected':''}>اختيار من متعدد</option>
            </select>
          </div>
          <div class="kv">
            <label>السؤال</label>
            <textarea data-field="text-${key}" placeholder="نص السؤال...">${q.text||''}</textarea>
          </div>
          ${imgBlock}
          <div class="kv">
            <label>الإجابة</label>
            <input data-field="answer-${key}" value="${q.answer||''}"/>
          </div>
          <div class="kv">
            <label>تلميح</label>
            <input data-field="hint-${key}" value="${q.hint||''}"/>
          </div>
          ${optBlock}
        </div>`;
    }

    function renderPackEditor(){
      const n = packCount(adminCat);
      if (!adminCat || n===0){ packEditor.innerHTML = `<div class="sub">—</div>`; return; }
      const pack = PACKS[adminCat][adminPackIdx] || defaultPack();

      const h100a = qBlock(pack[100][0] || {}, "١٠٠ (أ)", "100a");
      const h100b = qBlock(pack[100][1] || {}, "١٠٠ (ب)", "100b");
      const h200a = qBlock(pack[200][0] || {}, "٢٠٠ (أ)", "200a");
      const h200b = qBlock(pack[200][1] || {}, "٢٠٠ (ب)", "200b");
      const h300a = qBlock(pack[300][0] || {}, "٣٠٠ (أ)", "300a");
      const h300b = qBlock(pack[300][1] || {}, "٣٠٠ (ب)", "300b");
      const h400 = qBlock(Array.isArray(pack[400])? (pack[400][0]||{}) : pack[400] || {}, "٤٠٠ (احتياطي)", "400");

      packEditor.innerHTML = h100a + h100b + h200a + h200b + h300a + h300b + h400;

      const applyWire = (pts, sub, key)=>{
        const getQ = ()=> {
          PACKS[adminCat][adminPackIdx][pts] = PACKS[adminCat][adminPackIdx][pts] || [defaultQ(), defaultQ()];
          if (sub===null){ PACKS[adminCat][adminPackIdx][pts] = normalizeQ(PACKS[adminCat][adminPackIdx][pts]); return PACKS[adminCat][adminPackIdx][pts]; }
          PACKS[adminCat][adminPackIdx][pts][sub] = PACKS[adminCat][adminPackIdx][pts][sub] || defaultQ();
          return PACKS[adminCat][adminPackIdx][pts][sub];
        };
        const typeSel = packEditor.querySelector(`[data-field="type-${key}"]`);
        const qText = packEditor.querySelector(`[data-field="text-${key}"]`);
        const ans = packEditor.querySelector(`[data-field="answer-${key}"]`);
        const hint = packEditor.querySelector(`[data-field="hint-${key}"]`);
        const opts = packEditor.querySelector(`[data-field="options-${key}"]`);
        const corr = packEditor.querySelector(`[data-field="correct-${key}"]`);
        const imgInput = packEditor.querySelector(`[data-field="img-${key}"]`);
        const upload = packEditor.querySelector(`[data-upload="img-${key}"]`);
        const clear = packEditor.querySelector(`[data-clear="img-${key}"]`);
        const preview = packEditor.querySelector(`[data-preview="img-${key}"]`);

        const refreshMC = ()=>{
          const q = getQ();
          const show = q.type === 'mcq';
          $$(".mc", packEditor).forEach(el=>{
            const hasThis = el.querySelector(`[data-field$="${key}"]`) != null;
            if (hasThis) el.style.display = show? 'grid':'none';
          });
        };
        const refreshPreview = ()=>{
          const q = getQ();
          if (q.img){ preview.src = q.img; preview.style.display = 'block'; }
          else { preview.removeAttribute('src'); preview.style.display = 'none'; }
        };

        typeSel.addEventListener("change", ()=>{ const q=getQ(); q.type = typeSel.value; refreshMC(); savePacks(); showOk("تم تغيير نوع السؤال"); });
        qText.addEventListener("input", ()=>{ const q=getQ(); q.text = qText.value; savePacks(); });
        ans.addEventListener("input", ()=>{ const q=getQ(); q.answer = ans.value; savePacks(); });
        hint.addEventListener("input", ()=>{ const q=getQ(); q.hint = hint.value; savePacks(); });
        if (opts) opts.addEventListener("input", ()=>{ const q=getQ(); q.options = opts.value.split('|').map(s=>s.trim()).filter(Boolean); savePacks(); });
        if (corr) corr.addEventListener("input", ()=>{ const q=getQ(); q.correct = Math.max(1, Number(corr.value)||1); savePacks(); });

        imgInput.addEventListener("input", ()=>{ const q=getQ(); q.img = imgInput.value; savePacks(); refreshPreview(); });
        if (upload) upload.addEventListener("change", (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const r = new FileReader();
          r.onload = ()=>{ const q=getQ(); q.img = String(r.result); imgInput.value = q.img; savePacks(); refreshPreview(); showOk("تم رفع صورة السؤال."); };
          r.readAsDataURL(f);
          e.target.value = "";
        });
        if (clear) clear.addEventListener("click", ()=>{ const q=getQ(); q.img=""; imgInput.value=""; savePacks(); refreshPreview(); });

        refreshMC(); refreshPreview();
      };
      applyWire(100,0,"100a"); applyWire(100,1,"100b");
      applyWire(200,0,"200a"); applyWire(200,1,"200b");
      applyWire(300,0,"300a"); applyWire(300,1,"300b");
      // 400 (reserve)
      (function(){
        const key="400";
        const getQ = ()=>{ PACKS[adminCat][adminPackIdx][400] = PACKS[adminCat][adminPackIdx][400] || defaultQ(); return PACKS[adminCat][adminPackIdx][400]; };
        const typeSel = packEditor.querySelector(`[data-field="type-${key}"]`);
        const qText = packEditor.querySelector(`[data-field="text-${key}"]`);
        const ans = packEditor.querySelector(`[data-field="answer-${key}"]`);
        const hint = packEditor.querySelector(`[data-field="hint-${key}"]`);
        const opts = packEditor.querySelector(`[data-field="options-${key}"]`);
        const corr = packEditor.querySelector(`[data-field="correct-${key}"]`);
        const imgInput = packEditor.querySelector(`[data-field="img-${key}"]`);
        const upload = packEditor.querySelector(`[data-upload="img-${key}"]`);
        const clear = packEditor.querySelector(`[data-clear="img-${key}"]`);
        const preview = packEditor.querySelector(`[data-preview="img-${key}"]`);

        const refreshMC = ()=>{
          const q = getQ();
          const show = q.type === 'mcq';
          $$(".mc", packEditor).forEach(el=>{
            const hasThis = el.querySelector(`[data-field$="${key}"]`) != null;
            if (hasThis) el.style.display = show? 'grid':'none';
          });
        };
        const refreshPreview = ()=>{
          const q = getQ();
          if (q.img){ preview.src = q.img; preview.style.display = 'block'; }
          else { preview.removeAttribute('src'); preview.style.display = 'none'; }
        };

        typeSel.addEventListener("change", ()=>{ const q=getQ(); q.type = typeSel.value; refreshMC(); savePacks(); });
        qText.addEventListener("input", ()=>{ const q=getQ(); q.text = qText.value; savePacks(); });
        ans.addEventListener("input", ()=>{ const q=getQ(); q.answer = ans.value; savePacks(); });
        hint.addEventListener("input", ()=>{ const q=getQ(); q.hint = hint.value; savePacks(); });
        if (opts) opts.addEventListener("input", ()=>{ const q=getQ(); q.options = opts.value.split('|').map(s=>s.trim()).filter(Boolean); savePacks(); });
        if (corr) corr.addEventListener("input", ()=>{ const q=getQ(); q.correct = Math.max(1, Number(corr.value)||1); savePacks(); });
        imgInput.addEventListener("input", ()=>{ const q=getQ(); q.img = imgInput.value; savePacks(); refreshPreview(); });
        if (upload) upload.addEventListener("change", (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const r = new FileReader();
          r.onload = ()=>{ const q=getQ(); q.img = String(r.result); imgInput.value = q.img; savePacks(); refreshPreview(); showOk("تم رفع صورة السؤال."); };
          r.readAsDataURL(f);
          e.target.value = "";
        });
        if (clear) clear.addEventListener("click", ()=>{ const q=getQ(); q.img=""; imgInput.value=""; savePacks(); refreshPreview(); });

        refreshMC(); refreshPreview();
      })();
    }

    // Cat actions
    btnAddCat.addEventListener("click", ()=>{
      const name = prompt("اسم الفئة الجديدة:");
      if (!name) return;
      if (PACKS[name]) { showError("اسم الفئة موجود مسبقًا."); return; }
      PACKS[name] = [ defaultPack() ];
      META[name] = { img: coverDataUrl(name) };
      store.setItem(LS.packs, JSON.stringify({packs:PACKS}));
      store.setItem(LS.meta, JSON.stringify(META));
      adminCat = name; adminPackIdx = 0;
      usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تمت إضافة الفئة بصورة افتراضية.");
    });
    btnRenameCat.addEventListener("click", ()=>{
      if (!adminCat) return;
      const name = prompt("اسم الفئة الجديد:", adminCat);
      if (!name || name===adminCat) return;
      if (PACKS[name]) { showError("اسم مستخدم بالفعل."); return; }
      PACKS[name] = PACKS[adminCat]; delete PACKS[adminCat];
      if (META[adminCat]){ META[name] = META[adminCat]; delete META[adminCat]; }
      if (selectedCats){ selectedCats = selectedCats.map(c=>c===adminCat?name:c); store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); store.setItem(LS.numCats, String(selectedNum)); }
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}"); if (p[adminCat]!=null){ p[name]=p[adminCat]; delete p[adminCat]; store.setItem(LS.packIndex, JSON.stringify(p)); }
      adminCat = name;
      usedMap = {}; store.setItem(LS.used, JSON.stringify(usedMap));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); store.setItem(LS.meta, JSON.stringify(META));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تمت إعادة التسمية.");
    });
    btnDeleteCat.addEventListener("click", ()=>{
      if (!adminCat) return;
      if (!confirm(`حذف الفئة "${adminCat}" نهائيًا؟`)) return;
      delete PACKS[adminCat];
      delete META[adminCat];
      if (selectedCats){ selectedCats = selectedCats.filter(c=>c!==adminCat); store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); }
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}"); delete p[adminCat]; store.setItem(LS.packIndex, JSON.stringify(p));
      adminCat = categories()[0] || null; adminPackIdx = 0;
      usedMap = {}; store.setItem(LS.used, JSON.stringify(usedMap));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); store.setItem(LS.meta, JSON.stringify(META));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تم حذف الفئة.");
    });

    // Pack actions
    btnAddPack.addEventListener("click", ()=>{
      if (!adminCat) return;
      PACKS[adminCat] = PACKS[adminCat] || [];
      PACKS[adminCat].push(defaultPack());
      adminPackIdx = PACKS[adminCat].length-1;
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تمت إضافة الحزمة.");
    });
    btnDupPack.addEventListener("click", ()=>{
      if (!adminCat || packCount(adminCat)===0) return;
      const dup = deepClone(PACKS[adminCat][adminPackIdx]);
      PACKS[adminCat].push(dup);
      adminPackIdx = PACKS[adminCat].length-1;
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تم نسخ الحزمة.");
    });
    btnDelPack.addEventListener("click", ()=>{
      if (!adminCat || packCount(adminCat)===0) return;
      if (!confirm("حذف هذه الحزمة؟")) return;
      PACKS[adminCat].splice(adminPackIdx,1);
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}");
      if ((p[adminCat]||0) >= packCount(adminCat)){ p[adminCat]=0; store.setItem(LS.packIndex, JSON.stringify(p)); }
      adminPackIdx = Math.max(0, Math.min(adminPackIdx, packCount(adminCat)-1));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("تم حذف الحزمة.");
    });

    // Save/Clear/Auto category image
    btnSaveCatImg.addEventListener("click", ()=>{ if (!adminCat) return; const url = (catImgUrl.value||"").trim(); META[adminCat] = META[adminCat] || {}; META[adminCat].img = url; saveMeta(); refreshCatSettings(); renderBoard(); showOk("تم حفظ صورة الفئة."); });
    btnAutoCatImg.addEventListener("click", ()=>{ if (!adminCat) return; META[adminCat] = META[adminCat] || {}; META[adminCat].img = coverDataUrl(adminCat); saveMeta(); refreshCatSettings(); renderBoard(); showOk("تم تعيين صورة افتراضية تلقائيًا."); });
    btnClearCatImg.addEventListener("click", ()=>{ if (!adminCat) return; META[adminCat] = META[adminCat] || {}; META[adminCat].img = ""; saveMeta(); refreshCatSettings(); renderBoard(); showOk("تم حذف صورة الفئة."); });
    catImgFile.addEventListener("change", (e)=>{ const f = e.target.files[0]; if(!f || !adminCat) return; const r = new FileReader(); r.onload = ()=>{ META[adminCat] = META[adminCat] || {}; META[adminCat].img = String(r.result); saveMeta(); refreshCatSettings(); renderBoard(); showOk("تم رفع الصورة وحفظها."); }; r.readAsDataURL(f); e.target.value = ""; });

    // Photo search (optional online)
    btnSaveKeys.addEventListener("click", ()=>{ API.unsplash = (unsplashKey.value||"").trim(); API.pixabay = (pixabayKey.value||"").trim(); store.setItem(LS.api, JSON.stringify(API)); showOk("تم حفظ مفاتيح API محليًا."); });
    async function searchUnsplash(q){ if (!API.unsplash){ showError("أدخل Unsplash Access Key أولًا.", ""); return []; } const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(q)}&per_page=24&orientation=landscape&content_filter=high&client_id=${encodeURIComponent(API.unsplash)}`; const res = await fetch(url); if (!res.ok) throw new Error("Unsplash error " + res.status); const data = await res.json(); return (data.results||[]).map(r=>({thumb:r.urls.small, full:r.urls.regular})); }
    async function searchPixabay(q){ if (!API.pixabay){ showError("أدخل Pixabay API Key أولًا.", ""); return []; } const url = `https://pixabay.com/api/?key=${encodeURIComponent(API.pixabay)}&q=${encodeURIComponent(q)}&image_type=photo&orientation=horizontal&per_page=25&safesearch=true`; const res = await fetch(url); if (!res.ok) throw new Error("Pixabay error " + res.status); const data = await res.json(); return (data.hits||[]).map(r=>({thumb:r.previewURL, full:r.webformatURL})); }
    btnSearchImg.addEventListener("click", async ()=>{
      const q = (imgQuery.value||"").trim();
      if (!q){ showError("اكتب كلمة للبحث.", ""); return; }
      imgResults.innerHTML = "<div class='sub'>... جارِ البحث</div>";
      try{
        const prov = imgProvider.value;
        const items = prov==='unsplash' ? await searchUnsplash(q) : await searchPixabay(q);
        if (!items || !items.length){ imgResults.innerHTML = "<div class='sub'>لا نتائج</div>"; return; }
        imgResults.innerHTML = items.map((it,i)=>`
          <div class="resultCard">
            <img src="${it.thumb}" alt="" />
            <div class="meta">
              <span>${i+1}</span>
              <button class="btn" data-choose="${encodeURIComponent(it.full)}" title="تعيين كصورة للفئة">اختيار</button>
            </div>
          </div>
        `).join("");
        $$("[data-choose]").forEach(b=> b.addEventListener("click", e=>{
          const full = decodeURIComponent(e.currentTarget.getAttribute("data-choose"));
          if (!adminCat) return;
          META[adminCat] = META[adminCat] || {};
          META[adminCat].img = full;
          saveMeta();
          refreshCatSettings();
          renderBoard();
          showOk("تم تعيين الصورة للفئة.");
        }));
      }catch(err){ showError("فشل البحث عن الصور", err); imgResults.innerHTML=""; }
    });

    // Export / Import
    btnExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify({packs:PACKS, meta:META}, null, 2)], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "seen-jeem-data-v6.5.json";
      a.click();
      URL.revokeObjectURL(a.href);
      showOk("تم تصدير (حِزم + صور الفئات + صور الأسئلة).");
    });

    document.addEventListener("keydown", (e)=>{ const lbl=document.getElementById("lblImport"); if (lbl && e.altKey) lbl.firstChild.textContent = "استيراد (استبدال)"; });
    document.addEventListener("keyup", (e)=>{ const lbl=document.getElementById("lblImport"); if (lbl && !e.altKey) lbl.firstChild.textContent = "استيراد (إضافة)"; });

    fileImport.addEventListener("change", (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const replaceAll = (window.event && window.event.altKey) || false;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const raw = JSON.parse(String(reader.result));
          let packsData = raw.packs ?? raw;
          let metaData = raw.meta || {};
          if (Array.isArray(packsData)){
            const targetCat = prompt("اسم الفئة التي تريد إضافة هذه الحِزم إليها (فئة جديدة أو موجودة):");
            if (!targetCat) throw new Error("تم إلغاء الاستيراد.");
            packsData = { [targetCat]: packsData };
          }
          if (replaceAll){ PACKS = {}; META = {}; }
          if (packsData && typeof packsData === "object"){
            for (const cat of Object.keys(packsData)){
              const arr = packsData[cat];
              if (!Array.isArray(arr)) continue;
              if (!PACKS[cat]) PACKS[cat] = [];
              arr.forEach(p=>{ PACKS[cat].push(normalizePack(p)); });
              META[cat] = META[cat] || { img: coverDataUrl(cat) };
            }
          }
          if (metaData && typeof metaData === "object"){
            for (const cat of Object.keys(metaData)){
              META[cat] = META[cat] || {};
              if (metaData[cat].img) META[cat].img = metaData[cat].img;
            }
          }
          savePacks(); saveMeta();
          usedMap={}; saveUsed();
          renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
          showOk(replaceAll ? `اُستبدلت البيانات (حِزم + صور).` : `تمت الإضافة/الدمج.`);
        }catch(err){ showError("فشل الاستيراد", err); }
      };
      reader.readAsText(f, "utf-8");
      e.target.value = "";
    });

    // ==== Events ====
    $("#btnTest").addEventListener("click", ()=>{ const now = Date.now(); $("#btnTest").textContent = "تم! " + now.toString().slice(-6); });
    btnManage.addEventListener("click", openAdmin);
    btnShowSetup.addEventListener("click", openSetup);
    numCats.addEventListener("input", enforceNumSelection);
    catsChecklist.addEventListener("change", (e)=>{ if (e.target.classList.contains("catCheck")) enforceNumSelection(); });
    btnRandCats.addEventListener("click", ()=>{
      const all = categories(); const N = Math.min(selectedNum, all.length);
      const chosen = shuffle(all).slice(0,N);
      $$("input.catCheck", catsChecklist).forEach(i => i.checked = chosen.includes(i.value));
      enforceNumSelection();
    });
    btnStartGame.addEventListener("click", ()=>{
      const cats = $$("input.catCheck", catsChecklist).filter(i=>i.checked).map(i=>i.value);
      cats.forEach(cat => {
        const picker = catsChecklist.querySelector(`.packPick[data-cat="${CSS.escape(cat)}"]`);
        if (picker){ packIndexByCat[cat] = Number(picker.value||"0")|0; }
      });
      store.setItem(LS.packIndex, JSON.stringify(packIndexByCat));
      selectedCats = cats; store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); store.setItem(LS.numCats, String(selectedNum));
      usedMap = {}; saveUsed();
      teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams));
      lifelinesUsed = {}; saveLife();
      renderTeams();
      renderSelectedCatsView(); renderBoard();
      setup.style.display = "none";
    });

    btnAddTeam.addEventListener("click", ()=>{ const t={id:uid(),name:`فريق ${teams.length+1}`,score:0}; teams.push(t); ensureLife(t.id); renderTeams(); store.setItem(LS.teams, JSON.stringify(teams)); saveLife(); });
    btnZeroScores.addEventListener("click", ()=>{ teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams)); renderTeams(); });
    btnReset.addEventListener("click", ()=>{ usedMap = {}; saveUsed(); renderBoard(); closeQuestion(); });
    btnNextGame.addEventListener("click", ()=>{
      activeCategories().forEach(cat => { const n = packCount(cat); if (!n) return; packIndexByCat[cat] = (currentPackIndex(cat) + 1) % n; });
      store.setItem(LS.packIndex, JSON.stringify(packIndexByCat));
      usedMap = {}; saveUsed();
      teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams));
      lifelinesUsed = {}; saveLife();
      renderTeams();
      renderBoard(); renderSelectedCatsView(); closeQuestion();
    });

    inpPrimary.addEventListener("input", ()=>{ const n = Math.max(5, Number(inpPrimary.value)||60); settings.primarySec = n; store.setItem(LS.settings, JSON.stringify(settings)); if(phase==="primary") { setSeconds(n); renderLifelines(); } });
    inpSteal.addEventListener("input", ()=>{ const n = Math.max(5, Number(inpSteal.value)||10); settings.stealSec = n; store.setItem(LS.settings, JSON.stringify(settings)); if(phase==="steal") { setSeconds(n); renderLifelines(); } });
    inpTitle.addEventListener("input", ()=>{ settings.boardTitle = inpTitle.value; boardTitle.textContent = settings.boardTitle; store.setItem(LS.settings, JSON.stringify(settings)); });
    chkConfetti.addEventListener("change", ()=>{ settings.showConfetti = chkConfetti.checked; store.setItem(LS.settings, JSON.stringify(settings)); });
    chkAutoTurn.addEventListener("change", ()=>{ settings.autoTurn = chkAutoTurn.checked; store.setItem(LS.settings, JSON.stringify(settings)); });

    btnCloseQ.addEventListener("click", ()=>{ closeQuestion(); });
    btnReveal.addEventListener("click", ()=>{ const shown = answerWrap.style.display!=="none"; answerWrap.style.display = shown?"none":"block"; btnReveal.textContent = shown?"إظهار الإجابة":"إخفاء الإجابة"; });
    btnPause.addEventListener("click", ()=>{ if(timerInt){ stopTick(); } else { startTick(); } });
    btnResetTimer.addEventListener("click", ()=>{ if (phase==="primary") setSeconds(settings.primarySec||60); else if (phase==="steal") setSeconds(settings.stealSec||10); });
    btnHint.addEventListener("click", ()=>{});
    btnNoOne.addEventListener("click", ()=>{
      if (current && current.cat!=null) {
        const prevPrimary = primaryTeamId;
        markUsed(current.cat, current.pack, current.pts, current.sub);
        closeQuestion();
        advanceTurnAfterQuestion(prevPrimary);
      }
    });
    btnForceSteal.addEventListener("click", ()=>{ if (phase === "primary" && stealTeamId){ startStealPhase(); } });

    // 🔓 Global click un-blocker
    btnClickFix.addEventListener("click", ()=>{
      try{
        document.querySelectorAll('*').forEach(el=>{
          const st = getComputedStyle(el);
          const isOverlay = (st.position==='fixed' || st.position==='sticky') && !el.closest('header') && !el.closest('#setup') && !el.closest('#admin');
          if (isOverlay){ el.style.pointerEvents = 'none'; }
        });
        showOk("تم تعطيل أي طبقات قد تحجب النقر.");
      }catch(e){ showError("تعذر تنفيذ إصلاح النقر", e); }
    });

    // ==== Confetti ====
    function confetti(){
      for(let i=0;i<60;i++){
        const s = document.createElement("span");
        s.className = 'fx-star';
        s.textContent = "★"; s.style.position="fixed"; s.style.left = (Math.random()*100) + "vw"; s.style.top = "-2vh"; s.style.fontSize = (12+Math.random()*18)+"px"; s.style.opacity = .9; s.style.transition = "transform 1.2s ease, opacity 1.2s ease"; s.style.zIndex = 9; document.body.appendChild(s);
        requestAnimationFrame(()=>{ s.style.transform = `translateY(${90+Math.random()*10}vh) rotate(${Math.random()*360}deg)`; s.style.opacity = 0; });
        setTimeout(()=> s.remove(), 1300);
      }
    }
    window.confetti = confetti;

    // ==== Initial paint ====
    Object.keys(PACKS).forEach(cat=>{ PACKS[cat] = (PACKS[cat]||[]).map(normalizePack); META[cat] = META[cat] || {}; });
    savePacks(); saveMeta(); saveAPI();
    teams.forEach(t=>ensureLife(t.id)); saveLife();
    renderTeams(); renderSelectedCatsView(); renderBoard();
    if (!selectedCats) { setup.style.display="block"; populateChecklist(); }

  } catch (err) {
    const bar = document.getElementById("errorBar");
    if (bar){ bar.textContent = "⚠️ فشل تهيئة الواجهة — " + (err.message||err); bar.style.display="block"; }
    console.error(err);
  }
})();
</script>
</body>
</html>