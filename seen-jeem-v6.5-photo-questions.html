<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø³ÙŠÙ† Ø¬ÙŠÙ… â€” v6.5 (ØµÙˆØ± ÙƒØ¨ÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)</title>
  <style>
    :root{
      --bg:#0b1021; --panel:#111936; --muted:#1c254b; --ink:#f1f5f9; --sub:#94a3b8; --brand:#6366f1; --ok:#22c55e; --danger:#ef4444; --warn:#eab308;
      --rad:18px; --pad:16px; --shadow:0 10px 35px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 800px at 80% -10%, rgba(99,102,241,.25), transparent 60%),
      radial-gradient(900px 700px at 10% -10%, rgba(34,197,94,.18), transparent 50%),
      var(--bg);
      color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    }
    .container{max-width:1350px;margin-inline:auto;padding:20px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(22px, 3.2vw, 32px)}
    .sub{color:var(--sub);font-size:14px}
    .btn{background:var(--muted);color:var(--ink);border:1px solid #2b3469;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;box-shadow:0 1px 0 #000 inset}
    .btn:hover{filter:brightness(1.07)}
    .btn.brand{background:var(--brand);border-color:#545bf0}
    .btn.green{background:#15803d;border-color:#166534}
    .btn.red{background:#b91c1c;border-color:#991b1b}
    .btn.warn{background:#b45309;border-color:#92400e}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), transparent), var(--panel);border:1px solid #20284f;border-radius:var(--rad);padding:var(--pad);box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, select, textarea{background:#0b122b;border:1px solid #2b3469;color:var(--ink);border-radius:10px;padding:8px 10px;outline:none;min-height:38px}
    input[type="number"]{width:110px} textarea{min-height:78px}
    .team{display:flex;align-items:center;justify-content:space-between;background:rgba(148,163,184,.08);border:1px solid #273266;border-radius:14px;padding:8px}
    .score{font-size:22px;font-weight:800;min-width:3ch;text-align:center}
    .board{margin-top:16px}
    .cat{font-weight:700;color:#cbd5e1;text-align:center;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center}
    .catPic{width:86px;height:52px;border-radius:14px;border:1px solid #2a356b;background:#0b1021 center/cover no-repeat;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
    .tile{height:70px;display:flex;align-items:center;justify-content:center;border-radius:22px;font-size:24px;font-weight:900;border:1px solid #4f58e5;background:linear-gradient(180deg, rgba(255,255,255,.05), transparent), #4f46e5;cursor:pointer;transition:.15s}
    .tile:hover{transform:translateY(-1px)} .tile.used{background:#0b1020;border-color:#1e2740;color:#475569;cursor:not-allowed;transform:none}
    .ghost{height:70px;border-radius:22px;border:1px dashed #334155;background:transparent}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2b3469;border-radius:999px;background:rgba(148,163,184,.08)}
    .chip .thumb{width:22px;height:22px;border-radius:6px;background:#0b1021 center/cover no-repeat;border:1px solid #293162}
    .errorbar{position:sticky;top:0;background:#7f1d1d;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid #991b1b;margin-bottom:10px;display:none;z-index:9999}
    .okbar{position:sticky;top:0;background:#064e3b;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid #065f46;margin-bottom:10px;display:none;z-index:9999}
    .spacer{height:8px}
    .catRow{display:grid;grid-template-columns: auto auto 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #273266;border-radius:12px;background:rgba(148,163,184,.05)}
    .catRow .thumb{width:32px;height:32px;border-radius:8px;background:#0b1021 center/cover no-repeat;border:1px solid #293162}
    .tag{font-size:12px;opacity:.8;margin-inline-start:.5ch}
    @media (min-width: 980px){ .twocol{grid-template-columns:1fr 1fr} .threecol{grid-template-columns:2fr 1fr} }
    #admin{display:none}
    .list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
    .list button{justify-content:space-between}
    .mini{font-size:12px;opacity:.8}
    .fieldset{border:1px dashed #334155;border-radius:12px;padding:10px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin-bottom:8px}
    .fx-star { pointer-events: none !important; }
    .catSettings{margin-top:10px;border-top:1px dashed #2c3569;padding-top:10px}
    .banner{display:flex;align-items:center;gap:10px}
    .banner .bannerPic{width:60px;height:60px;border-radius:12px;background:#0b1021 center/cover no-repeat;border:1px solid #2a356b}
    .results{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px,1fr));gap:10px}
    .resultCard{border:1px solid #2a356b;border-radius:10px;overflow:hidden;background:#0b1021}
    .resultCard img{width:100%;height:90px;object-fit:cover;display:block}
    .resultCard .meta{padding:6px;font-size:12px;color:#94a3b8;display:flex;align-items:center;justify-content:space-between}
    /* Question image big view */
    #qImgWrap{margin-top:12px; display:none}
    #qImg{width:100%; max-height:55vh; object-fit:contain; background:#0b1021; border-radius:12px; border:1px solid #273266}
  </style>
</head>
<body>
  <div class="container">
    <div id="errorBar" class="errorbar"></div>
    <div id="okBar" class="okbar"></div>
    <header>
      <div>
        <h1 id="boardTitle">Ø³ÙŠÙ† Ø¬ÙŠÙ… â€” v6.5</h1>
        <div class="sub">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ¶Ø¹ <b>ØµÙˆØ± ÙƒØ¨ÙŠØ±Ø©</b> Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù†ÙØ³Ù‡Ø§ (Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø±ÙØ¹ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ). Ø§Ù„ØªØ±ØªÙŠØ¨: 100,100,200,200,300,300.</div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn brand" id="btnShowSetup">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
          <button class="btn" id="btnNextGame">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­ÙØ²Ù…)</button>
          <button class="btn" id="btnReset">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·</button>
          <button class="btn" id="btnManage">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
          <button class="btn" id="btnClickFix">ğŸ”“ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‚Ø±</button>
          <button class="btn" id="btnTest">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‚Ø±</button>
        </div>
      </div>
      <div class="panel">
        <strong>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±ÙŠØ¹</strong>
        <div class="grid" style="gap:10px;margin-top:10px">
          <div class="row">
            <label class="sub">Ù…Ø¯Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
            <input type="number" id="inpPrimary" value="60" min="5" step="5" />
            <label class="sub">Ù…Ø¯Ø© Ø§Ù„ÙØ±ØµØ©</label>
            <input type="number" id="inpSteal" value="10" min="5" step="5" />
          </div>
          <div class="row">
            <label class="sub">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„ÙˆØ­Ø©</label>
            <input id="inpTitle" value="Ø³ÙŠÙ† Ø¬ÙŠÙ… â€” Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ©" />
          </div>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="chkAutoTurn" checked />
            <span>ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø³Ø¤Ø§Ù„</span>
          </label>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="chkConfetti" checked />
            <span>Ù…Ø¤Ø«Ø± Ø§Ø­ØªÙØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</span>
          </label>
          <div class="panel" style="padding:10px">
            <div class="sub" style="margin-bottom:6px">Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
            <div id="selectedCatsView" class="grid" style="gap:8px"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Setup -->
    <section id="setup" class="panel" style="margin-top:12px;display:none">
      <h3 style="margin:0 0 6px 0">Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <div class="sub">Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¦Ø§ØªØŒ Ø«Ù… Ø­Ø¯Ù‘Ø¯ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ­ÙØ²Ù…Ø© ÙƒÙ„ ÙØ¦Ø©.</div>
      <div class="row" style="margin-top:10px">
        <label class="sub">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¦Ø§Øª</label>
        <input type="number" id="numCats" min="3" max="10" value="6" />
        <button class="btn" id="btnRandCats">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
        <button class="btn brand" id="btnStartGame">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      </div>
      <div id="catsChecklist" class="grid" style="gap:10px;margin-top:10px"></div>
    </section>

    <!-- Admin Manager -->
    <section id="admin" class="panel" style="margin-top:12px;display:none">
      <h3 style="margin:0 0 6px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø­ÙØ²Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
      <div class="sub">Ø£Ø¶Ù/Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø­ÙØ²Ù…ØŒ ÙˆØ­Ø±Ù‘Ø± Ø£Ø³Ø¦Ù„Ø© ÙƒÙ„ Ø­Ø²Ù…Ø©. Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø©.</div>
      <div class="grid" style="grid-template-columns: 1fr 1fr 2fr; gap:14px; margin-top:10px">
        <!-- Categories -->
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <strong>Ø§Ù„ÙØ¦Ø§Øª</strong>
            <div class="row">
              <button class="btn" id="btnAddCat">+ ÙØ¦Ø©</button>
              <button class="btn" id="btnRenameCat">Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©</button>
              <button class="btn red" id="btnDeleteCat">Ø­Ø°Ù</button>
            </div>
          </div>
          <div id="catList" class="list" style="margin-top:8px"></div>
        </div>
        <!-- Packs -->
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <strong>Ø§Ù„Ø­ÙØ²Ù…</strong>
            <div class="row">
              <button class="btn" id="btnAddPack">+ Ø­Ø²Ù…Ø©</button>
              <button class="btn" id="btnDupPack">Ù†Ø³Ø®</button>
              <button class="btn red" id="btnDelPack">Ø­Ø°Ù</button>
            </div>
          </div>
          <div id="packList" class="list" style="margin-top:8px"></div>
        </div>
        <!-- Editor / Category settings -->
        <div class="panel">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <strong id="editorTitle">Ø§Ù„Ù…Ø­Ø±Ù‘Ø±</strong>
              <div class="sub" id="editorSub"></div>
            </div>
            <div class="row">
              <button class="btn" id="btnExport">ØªØµØ¯ÙŠØ±</button>
              <label class="btn" id="lblImport">
                Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø¥Ø¶Ø§ÙØ©)
                <input type="file" id="fileImport" accept=".json" style="display:none">
              </label>
            </div>
          </div>

          <!-- Category picture tools (as before) -->
          <div class="banner catSettings">
            <div class="bannerPic" id="catPreview"></div>
            <div class="grid" style="gap:8px;flex:1">
              <div class="kv">
                <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø© (Ø±Ø§Ø¨Ø·)</label>
                <input id="catImgUrl" placeholder="https://example.com/pic.jpg" />
              </div>
              <div class="row">
                <label class="btn">
                  Ø±ÙØ¹ ØµÙˆØ±Ø©<input type="file" id="catImgFile" accept="image/*" style="display:none">
                </label>
                <button class="btn" id="btnAutoCatImg">ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                <button class="btn" id="btnSaveCatImg">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
                <button class="btn red" id="btnClearCatImg">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
              </div>
              <div class="sub">ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ (Unsplash / Pixabay).</div>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <strong>Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© Ù„Ù„ÙØ¦Ø©</strong>
            <div class="grid" style="gap:8px;margin-top:8px">
              <div class="row">
                <label>Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯</label>
                <select id="imgProvider">
                  <option value="unsplash">Unsplash</option>
                  <option value="pixabay">Pixabay</option>
                </select>
                <input id="imgQuery" placeholder="Ù…Ø«Ø§Ù„: Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ ØªØ§Ø±ÙŠØ®ØŒ Ø±ÙŠØ§Ø¶Ø©..." style="flex:1" />
                <button class="btn" id="btnSearchImg">Ø¨Ø­Ø«</button>
              </div>
              <div class="row">
                <input id="unsplashKey" placeholder="Unsplash Access Key" style="flex:1" />
                <input id="pixabayKey" placeholder="Pixabay API Key" style="flex:1" />
                <button class="btn" id="btnSaveKeys">Ø­ÙØ¸ Ø§Ù„Ù…ÙØ§ØªÙŠØ­</button>
              </div>
              <div class="sub">Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØªÙØ®Ø²Ù‘ÙÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</div>
              <div id="imgResults" class="results"></div>
            </div>
          </div>

          <div id="packEditor" style="margin-top:10px"></div>
          <div class="row" style="margin-top:8px;justify-content:flex-end">
            <button class="btn green" id="btnSaveAll">Ø­ÙØ¸ Ø§Ù„ÙƒÙ„</button>
            <button class="btn" id="btnCloseAdmin">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
          </div>
        </div>
      </div>
    </section>

    <section class="grid twocol" style="margin-top:12px">
      <div class="panel">
        <div class="row" style="justify-content:space-between;margin-bottom:10px">
          <strong>Ø§Ù„ÙØ±Ù‚ Ùˆ Ø§Ù„Ù†Ù‚Ø§Ø·</strong>
          <div class="row">
            <button class="btn" id="btnAddTeam">Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚</button>
            <button class="btn red" id="btnZeroScores">ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·</button>
          </div>
        </div>
        <div id="teams" class="grid" style="gap:10px"></div>
        <div class="sub">ÙŠÙØ¯Ø§Ø± Ø§Ù„Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø³Ø¤Ø§Ù„ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„Ù‡)ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‡Ù†Ø§.</div>
      </div>

      <div class="panel board">
        <div id="board"></div>
        <!-- Inline question drawer -->
        <div id="qDrawer" class="panel" style="margin-top:14px; display:none; border-color:#1f453b;background:linear-gradient(180deg, rgba(34,197,94,.08), transparent)">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="row" style="gap:10px;align-items:center">
              <div class="bannerPic" id="qCatPic" style="width:48px;height:48px"></div>
              <div>
                <div class="sub"><span id="qCat"></span> â€” <span id="qPts"></span> Ù†Ù‚Ø·Ø© <span id="packTag" class="tag"></span> <span id="qSubIdx" class="tag"></span></div>
                <h3 id="qTitle" style="margin:4px 0 0 0"></h3>
              </div>
            </div>
            <button class="btn" id="btnCloseQ">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>

          <!-- BIG image for question -->
          <div id="qImgWrap">
            <img id="qImg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„" />
          </div>

          <div id="qOptions" class="grid" style="gap:10px;margin-top:10px"></div>

          <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
            <span class="chip" id="phaseChip">Ø§Ù„Ø¯ÙˆØ±: â€”</span>
            <span class="chip">Ø§Ù„ÙˆÙ‚Øª: <b id="tLeft">60</b>s</span>
            <button class="btn" id="btnForceSteal">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ÙØ±ØµØ© 10 Ø«ÙˆØ§Ù†Ù</button>
            <div class="row" style="margin-inline-start:auto;gap:8px">
              <button class="btn" id="btnPause">Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„</button>
              <button class="btn" id="btnResetTimer">ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª</button>
            </div>
          </div>

          <div id="answerWrap" class="panel" style="margin-top:10px;display:none">
            <div class="sub">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
            <div id="qAnswer" style="font-size:22px;font-weight:800;margin-top:6px"></div>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="sub" style="margin-bottom:6px">ÙˆØ³Ø§Ø¦Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©</div>
            <div id="lifelinesArea" class="grid" style="gap:8px"></div>
          </div>

          <div class="row" style="gap:10px;margin-top:10px">
            <button class="btn" id="btnHint" style="display:none">ØªÙ„Ù…ÙŠØ­</button>
            <button class="btn" id="btnReveal">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
            <button class="btn warn" id="btnNoOne" style="margin-inline-start:auto">Ù„Ø§ Ø£Ø­Ø¯ Ø£Ø¬Ø§Ø¨ â€” Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="sub" style="margin-bottom:6px">Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø°ÙŠ Ø£Ø¬Ø§Ø¨ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
            <div id="awardBtns" class="row" style="flex-wrap:wrap;gap:8px"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const showError = (msg, err) => {
    const bar = document.getElementById("errorBar");
    bar.textContent = "âš ï¸ " + msg + (err? " â€” " + (err.message||err): "");
    bar.style.display = "block";
    setTimeout(()=> bar.style.display="none", 5000);
    console.error(msg, err);
  };
  const showOk = (msg) => {
    const bar = document.getElementById("okBar");
    bar.textContent = "âœ… " + msg;
    bar.style.display = "block";
    setTimeout(()=> bar.style.display="none", 2500);
  };

  window.addEventListener("error", (e)=>{
    const bar = document.getElementById("errorBar");
    if (bar){ bar.textContent = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª: " + (e.message||e); bar.style.display="block"; }
  });

  try {
    // ==== Safe storage ====
    const store = (()=>{ try{ const k="__t__"+Math.random(); localStorage.setItem(k,"1"); localStorage.removeItem(k); return localStorage; } catch{ const mem={}; return { getItem:(k)=>k in mem?mem[k]:null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:(k)=>{delete mem[k]} }; } })();

    // ==== Utilities ====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,10);
    const shuffle = (arr) => { const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const escapeHtml = (str) => String(str).replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    const deepClone = (o) => JSON.parse(JSON.stringify(o));

    // ==== Auto category cover (same as v6.4) ====
    function emojiForCategory(name){
      const s = (name||"").toLowerCase();
      const rules = [
        {k:"Ø¬ØºØ±Ø§Ù", e:"ğŸŒ"}, {k:"ØªØ§Ø±ÙŠØ®", e:"ğŸ›ï¸"}, {k:"Ø¹Ù„ÙˆÙ…", e:"ğŸ§ª"}, {k:"Ø±ÙŠØ§Ø¶", e:"âš½"},
        {k:"ÙÙ†", e:"ğŸ¨"}, {k:"ØªÙ‚Ù†", e:"ğŸ’»"}, {k:"ØªÙƒÙ†ÙˆÙ„ÙˆØ¬", e:"ğŸ’»"}, {k:"Ø£Ø¯Ø¨", e:"ğŸ“š"},
        {k:"Ù„ØºØ©", e:"ğŸ—£ï¸"}, {k:"Ø¯ÙŠÙ†", e:"ğŸ•Œ"}, {k:"Ù‚Ø±Ø¢Ù†", e:"ğŸ•Œ"}, {k:"Ø£ÙÙ„Ø§Ù…", e:"ğŸ¬"},
        {k:"Ù…Ø³Ù„Ø³", e:"ğŸ¬"}, {k:"Ø³ÙŠÙ†Ù…Ø§", e:"ğŸ¬"}, {k:"Ù…ÙˆØ³ÙŠ", e:"ğŸµ"}, {k:"Ø·Ø¨ÙŠ", e:"ğŸŒ¿"},
        {k:"Ø­Ø§Ø³ÙˆØ¨", e:"ğŸ’»"}, {k:"Ø±ÙŠØ§Ø¶ÙŠØ§Øª", e:"â—"}, {k:"ÙƒÙŠÙ…ÙŠ", e:"ğŸ§ª"}, {k:"ÙÙŠØ²ÙŠ", e:"âš›ï¸"},
        {k:"Ø­ÙŠÙˆØ§Ù†", e:"ğŸ¾"}, {k:"Ø·Ø¹Ø§Ù…", e:"ğŸ½ï¸"}, {k:"Ø«Ù‚Ø§Ù", e:"ğŸ§­"}, {k:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", e:"ğŸ§ "}
      ];
      const hit = rules.find(r=> s.includes(r.k) );
      return hit? hit.e : "ğŸ§©";
    }
    function coverDataUrl(cat){
      const name = String(cat||"").trim();
      const emoji = emojiForCategory(name);
      let h = 0; for (let ch of name){ h = (h*33 + ch.codePointAt(0)) >>> 0; }
      const h1 = h % 360, h2 = (h + 90) % 360;
      const c1 = `hsl(${h1},70%,45%)`, c2 = `hsl(${h2},70%,35%)`;
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 360'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop offset='0%' stop-color='${c1}'/><stop offset='100%' stop-color='${c2}'/>
        </linearGradient></defs>
        <rect width='600' height='360' fill='url(#g)'/>
        <text x='50%' y='55%' font-size='160' text-anchor='middle' dominant-baseline='middle'>${emoji}</text>
        <text x='50%' y='92%' font-size='44' text-anchor='middle' fill='rgba(255,255,255,.9)'>${name}</text>
      </svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    // ==== Data ====
    let PACKS = JSON.parse(store.getItem("sj_packs_v6_5")||"null")?.packs ||
                JSON.parse(store.getItem("sj_packs_v6_4")||"null")?.packs ||
                JSON.parse(store.getItem("sj_packs_v6_3_admin")||"null")?.packs || null;
    if(!PACKS){
      PACKS = {"Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©":[{100:[{type:"open",text:"Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",answer:"Ø§Ù„Ø±ÙŠØ§Ø¶"},{type:"open",text:"",answer:""}],200:[{type:"open",text:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ",answer:"Ø³Ø¨Ø¹Ø© Ø£ÙŠØ§Ù…"},{type:"open",text:"",answer:""}],300:[{type:"open",text:"Ø£ÙŠ ÙƒÙˆÙƒØ¨ ÙŠÙØ¹Ø±Ù Ø¨Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ø­Ù…Ø±ØŸ",answer:"Ø§Ù„Ù…Ø±ÙŠØ®"},{type:"open",text:"",answer:""}],400:{type:"open",text:"Ù…Ø§ Ù‡Ùˆ Ø£ÙƒØ¨Ø± Ù…Ø­ÙŠØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ",answer:"Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ù‡Ø§Ø¯Ø¦"}}]};
    }
    let META = JSON.parse(store.getItem("sj_meta_v6_5") || "null") || {};
    Object.keys(PACKS).forEach(cat=>{ META[cat] = META[cat] || {}; if (!META[cat].img) META[cat].img = coverDataUrl(cat); });

    let API = JSON.parse(store.getItem("sj_api_keys_v6_5") || "null") || {unsplash:"", pixabay:""};

    const LS = {
      packs: "sj_packs_v6_5",
      packIndex: "sj_packIndex_v6_5",
      used: "sj_used_v6_5",
      teams: "sj_teams_v6_5",
      settings: "sj_settings_v6_5",
      selectedCats: "sj_selectedCats_v6_5",
      numCats: "sj_numCats_v6_5",
      activeTeam: "sj_activeTeam_v6_5",
      lifelines: "sj_lifelines_v6_5",
      meta: "sj_meta_v6_5",
      api: "sj_api_keys_v6_5"
    };

    if (!store.getItem(LS.packs)) { store.setItem(LS.packs, JSON.stringify({packs: PACKS})); }
    if (!store.getItem(LS.meta)) { store.setItem(LS.meta, JSON.stringify(META)); }
    if (!store.getItem(LS.api)) { store.setItem(LS.api, JSON.stringify(API)); }

    // ==== Points order ====
    const DISPLAY = [ {pts:100, idx:0}, {pts:100, idx:1}, {pts:200, idx:0}, {pts:200, idx:1}, {pts:300, idx:0}, {pts:300, idx:1} ];

    // ==== DOM ====
    const boardEl = $("#board"); const teamsEl = $("#teams");
    const btnAddTeam = $("#btnAddTeam"); const btnZeroScores = $("#btnZeroScores");
    const btnReset = $("#btnReset"); const btnNextGame = $("#btnNextGame");
    const btnShowSetup = $("#btnShowSetup"); const inpTitle = $("#inpTitle");
    const chkConfetti = $("#chkConfetti"); const boardTitle = $("#boardTitle");
    const selectedCatsView = $("#selectedCatsView");
    const inpPrimary = $("#inpPrimary"); const inpSteal = $("#inpSteal"); const chkAutoTurn = $("#chkAutoTurn");
    const btnManage = $("#btnManage"); const okBar = $("#okBar"); const btnClickFix = $("#btnClickFix");

    const setup = $("#setup"); const numCats = $("#numCats");
    const catsChecklist = $("#catsChecklist"); const btnStartGame = $("#btnStartGame"); const btnRandCats = $("#btnRandCats");

    const admin = $("#admin"); const btnAddCat = $("#btnAddCat"); const btnRenameCat = $("#btnRenameCat"); const btnDeleteCat = $("#btnDeleteCat");
    const btnAddPack = $("#btnAddPack"); const btnDupPack = $("#btnDupPack"); const btnDelPack = $("#btnDelPack");
    const catList = $("#catList"); const packList = $("#packList");
    const packEditor = $("#packEditor"); const editorTitle = $("#editorTitle"); const editorSub = $("#editorSub");
    const btnExport = $("#btnExport"); const fileImport = $("#fileImport"); const btnSaveAll = $("#btnSaveAll"); const btnCloseAdmin = $("#btnCloseAdmin"); const lblImport = $("#lblImport");
    const catPreview = $("#catPreview"); const catImgUrl = $("#catImgUrl"); const catImgFile = $("#catImgFile"); const btnSaveCatImg = $("#btnSaveCatImg"); const btnClearCatImg = $("#btnClearCatImg"); const btnAutoCatImg = $("#btnAutoCatImg");
    const imgProvider = $("#imgProvider"); const imgQuery = $("#imgQuery"); const btnSearchImg = $("#btnSearchImg"); const imgResults = $("#imgResults");
    const unsplashKey = $("#unsplashKey"); const pixabayKey = $("#pixabayKey"); const btnSaveKeys = $("#btnSaveKeys");

    const qDrawer = $("#qDrawer"); const qCat = $("#qCat"); const qPts = $("#qPts"); const qTitle = $("#qTitle"); const qOptions = $("#qOptions"); const qAnswer = $("#qAnswer");
    const answerWrap = $("#answerWrap"); const awardBtns = $("#awardBtns"); const btnNoOne = $("#btnNoOne"); const btnCloseQ = $("#btnCloseQ");
    const tLeft = $("#tLeft"); const btnPause = $("#btnPause"); const btnResetTimer = $("#btnResetTimer"); const btnReveal = $("#btnReveal"); const btnHint = $("#btnHint"); const btnForceSteal = $("#btnForceSteal");
    const phaseChip = $("#phaseChip"); const packTag = $("#packTag"); const lifelinesArea = $("#lifelinesArea"); const qCatPic = $("#qCatPic"); const qSubIdx = $("#qSubIdx");
    const qImgWrap = $("#qImgWrap"); const qImg = $("#qImg");

    // ==== State ====
    let packIndexByCat = JSON.parse(store.getItem(LS.packIndex) || "null") || {};
    let usedMap = JSON.parse(store.getItem(LS.used) || "null") || {};
    let teams = JSON.parse(store.getItem(LS.teams) || "null") || [ {id:uid(),name:"ÙØ±ÙŠÙ‚ Ù¡",score:0}, {id:uid(),name:"ÙØ±ÙŠÙ‚ Ù¢",score:0} ];
    let settings = JSON.parse(store.getItem(LS.settings) || "null") || { primarySec:60, stealSec:10, boardTitle:"Ø³ÙŠÙ† Ø¬ÙŠÙ… â€” Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ©", showConfetti:true, autoTurn:true };
    let selectedCats = JSON.parse(store.getItem(LS.selectedCats) || "null") || null;
    let selectedNum = Number(store.getItem(LS.numCats) || "6") || 6;
    let activeTeamId = JSON.parse(store.getItem(LS.activeTeam) || "null") || (teams[0] && teams[0].id);
    let lifelinesUsed = JSON.parse(store.getItem(LS.lifelines) || "null") || {};

    const ensureLife = (id)=>{ lifelinesUsed[id] = lifelinesUsed[id] || {steal:false,time:false,double:false,two:false}; return lifelinesUsed[id]; };
    const saveLife = ()=> store.setItem(LS.lifelines, JSON.stringify(lifelinesUsed));
    const savePacks = ()=> store.setItem(LS.packs, JSON.stringify({packs: PACKS}));
    const saveMeta = ()=> store.setItem(LS.meta, JSON.stringify(META));
    const saveAPI = ()=> store.setItem(LS.api, JSON.stringify(API));
    const saveActiveTeam = ()=> store.setItem(LS.activeTeam, JSON.stringify(activeTeamId));

    // ==== Helpers ====
    const categories = () => Object.keys(PACKS);
    const activeCategories = () => (selectedCats && selectedCats.length) ? selectedCats : categories().slice(0, Math.min(selectedNum, categories().length));
    const packCount = (cat) => (PACKS[cat] || []).length || 0;
    const currentPackIndex = (cat) => {
      const n = packCount(cat); if (!(cat in packIndexByCat)) packIndexByCat[cat] = 0;
      if (n === 0) return 0;
      if (packIndexByCat[cat] > n-1 || packIndexByCat[cat] < 0 || Number.isNaN(packIndexByCat[cat])) packIndexByCat[cat] = 0;
      return packIndexByCat[cat];
    };
    const keyFor = (cat, pack, pts, idx) => `${cat}|${pack}|${pts}|${idx}`;
    const catImg = (cat)=> (META[cat]?.img || coverDataUrl(cat));

    // ==== Render ====
    function renderSelectedCatsView(){
      const cats = activeCategories();
      selectedCatsView.innerHTML = cats.map(c=>{
        const img = catImg(c);
        return `<span class="chip"><span class="thumb" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></span>${escapeHtml(c)} <span class="tag">Ø­${currentPackIndex(c)+1}</span></span>`;
      }).join(" ");
    }

    function renderBoard(){
      const cats = activeCategories();
      const cols = `grid-template-columns: repeat(${cats.length}, minmax(0,1fr))`;
      let html = `<div class="grid" style="${cols}">` + cats.map(c=>{
        const img = catImg(c);
        return `<div class="cat">
          <div class="catPic" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></div>
          <div>${escapeHtml(c)} <span class="tag">Ø­${currentPackIndex(c)+1}</span></div>
        </div>`;
      }).join("") + `</div>`;
      html += `<div class="grid" style="gap:14px;${cols}">`;
      for(const row of DISPLAY){
        for(const c of cats){
          const pidx = currentPackIndex(c);
          const pack = PACKS[c] && PACKS[c][pidx];
          const arr = pack && pack[row.pts];
          const q = Array.isArray(arr) ? arr[row.idx] : (row.idx===0 ? arr : null);
          const hasText = q && ((q.text||"").trim().length>0 || (q.img||"").trim().length>0);
          if(!q || !hasText){ html += `<div class="ghost"></div>`; continue; }
          const used = !!usedMap[keyFor(c, pidx, row.pts, row.idx)];
          html += `<button class="${used?'tile used':'tile'}" data-cat="${c}" data-pts="${row.pts}" data-sub="${row.idx}" title="${escapeHtml(q.text||'')}">${row.pts}</button>`;
        }
      }
      html += `</div>`;
      boardEl.innerHTML = html;
      $$(".tile", boardEl).forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          const cat = ev.currentTarget.getAttribute("data-cat");
          const pts = Number(ev.currentTarget.getAttribute("data-pts"));
          const sub = Number(ev.currentTarget.getAttribute("data-sub"));
          const pidx = currentPackIndex(cat);
          const arr = PACKS[cat]?.[pidx]?.[pts];
          const q = Array.isArray(arr)? arr[sub] : (sub===0? arr : null);
          if(!q || usedMap[keyFor(cat,pidx,pts,sub)] || (!((q.text||"").trim().length>0 || (q.img||"").trim().length>0))) return;
          openQuestion(cat, pts, q, pidx, sub);
        });
      });
    }

    function renderTeams(){
      teamsEl.innerHTML = teams.map(t=>{
        const life = ensureLife(t.id);
        const lifeIcons = `<span class="mini">Ø³:${life.steal?"âœ…":"â€”"} Ø²:${life.time?"âœ…":"â€”"} Ù…:${life.double?"âœ…":"â€”"} Ù¢:${life.two?"âœ…":"â€”"}</span>`;
        return `<div class="team">
          <div class="row" style="gap:8px;align-items:center">
            <input type="radio" name="turn" class="activePick" ${t.id===activeTeamId?"checked":""} data-id="${t.id}" title="Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ" />
            <input value="${escapeHtml(t.name||'')}" data-id="${t.id}" class="teamName" style="width:160px"/>
            <div class="sub" style="font-size:12px">${lifeIcons}</div>
          </div>
          <div class="row">
            <button class="btn" data-id="${t.id}" data-delta="-50">-50</button>
            <span class="score">${t.score}</span>
            <button class="btn" data-id="${t.id}" data-delta="50">+50</button>
            <button class="btn red" data-remove="${t.id}">Ø­Ø°Ù</button>
          </div>
        </div>`;
      }).join("");

      $$(".activePick", teamsEl).forEach(inp=>{
        inp.addEventListener("change", (e)=>{ activeTeamId = e.target.getAttribute("data-id"); saveActiveTeam(); });
      });
      $$(".teamName", teamsEl).forEach(inp=>{
        inp.addEventListener("input", (e)=>{ const id = e.target.getAttribute("data-id"); const val = e.target.value; teams = teams.map(t=>t.id===id?{...t,name:val}:t); store.setItem(LS.teams, JSON.stringify(teams)); });
      });
      $$("[data-delta]", teamsEl).forEach(btn=>{
        btn.addEventListener("click", (e)=>{ const id = e.currentTarget.getAttribute("data-id"); const d = Number(e.currentTarget.getAttribute("data-delta")); teams = teams.map(t=>t.id===id?{...t,score:t.score + d}:t); store.setItem(LS.teams, JSON.stringify(teams)); renderTeams(); });
      });
      $$("[data-remove]", teamsEl).forEach(btn=>{
        btn.addEventListener("click", (e)=>{ const id = e.currentTarget.getAttribute("data-remove"); teams = teams.filter(t=>t.id!==id); if (activeTeamId===id) activeTeamId = teams[0]?.id; store.setItem(LS.teams, JSON.stringify(teams)); saveActiveTeam(); renderTeams(); });
      });
    }

    // ==== Question drawer & timing ====
    let current = {cat:null, pts:null, pack:null, sub:0};
    let timerInt = null;
    let phase = "idle"; // "primary" | "steal" | "done"
    let primaryTeamId = null, stealTeamId = null;
    let doubleForTeam = null;
    let twoAnswersTeam = null; let twoLeft = 0;

    function setSeconds(s){ tLeft.textContent = Math.max(0, s); tLeft.dataset.val = String(Math.max(0,s)); }
    function startTick(){
      stopTick();
      timerInt = setInterval(()=>{
        let s = Number(tLeft.dataset.val||"0");
        if (s>0){ setSeconds(s-1); }
        else {
          if (phase === "primary"){
            if (stealTeamId){ startStealPhase(); } else { phase = "done"; stopTick(); }
          } else if (phase === "steal"){ phase = "done"; stopTick(); }
        }
      }, 1000);
    }
    function stopTick(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }

    function startPrimaryPhase(){
      phase = "primary";
      phaseChip.textContent = `Ø§Ù„Ø¯ÙˆØ±: ${teamName(primaryTeamId)} â€” (${settings.primarySec||60} Ø«)`;
      setSeconds(settings.primarySec||60);
      startTick();
      renderLifelines();
    }
    function startStealPhase(){
      phase = "steal";
      phaseChip.textContent = `ÙØ±ØµØ©/Ø³Ø±Ù‚Ø©: ${teamName(stealTeamId)} â€” (${settings.stealSec||10} Ø«)`;
      setSeconds(settings.stealSec||10);
      startTick();
      renderLifelines();
    }

    function teamName(id){ const t = teams.find(x=>x.id===id); return t? t.name : "â€”"; }
    function nextTeamId(id){
      if (!teams.length) return null;
      const idx = Math.max(0, teams.findIndex(t=>t.id===id));
      return teams[(idx+1) % teams.length]?.id || null;
    }

    function openQuestion(cat, pts, q, pidx, sub){
      current = {cat, pts, pack:pidx, sub};
      qCat.textContent = cat; qPts.textContent = pts; qTitle.textContent = q.text || "";
      qAnswer.textContent = q.answer || ""; answerWrap.style.display="none"; btnReveal.textContent="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
      btnHint.style.display = q.hint? "inline-block":"none";
      packTag.textContent = `(Ø­${pidx+1})`; qSubIdx.textContent = sub===0? "(Ø£)" : "(Ø¨)";
      qCatPic.style.backgroundImage = `url('${(catImg(cat)||'').replace(/'/g,"%27")}')`;

      // BIG image
      if (q.img && q.img.trim()){
        qImg.src = q.img;
        qImgWrap.style.display = "block";
      } else {
        qImg.removeAttribute("src");
        qImgWrap.style.display = "none";
      }

      qOptions.innerHTML = "";
      if(q.type==="mcq" && q.options){
        q.options.forEach((opt,i)=>{
          const b = document.createElement("button");
          b.className = "btn"; b.style.width="100%"; b.textContent = String.fromCharCode(0x0627+i) + ". " + opt;
          qOptions.appendChild(b);
        });
      }

      awardBtns.innerHTML = teams.map(t=>`<button class="btn green" data-award="${t.id}">${escapeHtml(t.name||'')}</button>`).join("");
      $$("[data-award]", awardBtns).forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const id = e.currentTarget.getAttribute("data-award");
          const idx = teams.findIndex(t=>t.id===id);
          if(idx>=0){
            const multiplier = (doubleForTeam && id===doubleForTeam) ? 2 : 1;
            teams[idx] = {...teams[idx], score: teams[idx].score + current.pts * multiplier};
            store.setItem(LS.teams, JSON.stringify(teams)); renderTeams();
          }
          const prevPrimary = primaryTeamId;
          markUsed(current.cat, current.pack, current.pts, current.sub);
          if(settings.showConfetti) confetti();
          stopTick(); closeQuestion();
          advanceTurnAfterQuestion(prevPrimary);
        });
      });

      doubleForTeam = null; twoAnswersTeam = null; twoLeft = 0;

      primaryTeamId = activeTeamId || (teams[0] && teams[0].id);
      stealTeamId = nextTeamId(primaryTeamId);
      startPrimaryPhase();

      qDrawer.style.display = "block";
      qDrawer.scrollIntoView({behavior:"smooth", block:"center"});
    }
    function closeQuestion(){ qDrawer.style.display = "none"; phase="idle"; stopTick(); }

    function markUsed(cat, pidx, pts, sub){ usedMap[keyFor(cat, pidx, pts, sub)] = true; saveUsed(); renderBoard(); }
    function saveUsed(){ store.setItem(LS.used, JSON.stringify(usedMap)); }
    function advanceTurnAfterQuestion(prevPrimaryId){ if (!settings.autoTurn) return; const nxt = nextTeamId(prevPrimaryId); if (nxt){ activeTeamId = nxt; saveActiveTeam(); renderTeams(); } }

    // ==== Lifelines (same as v6.4) ====
    function renderLifelines(){
      const lifeFor = (teamId)=> ensureLife(teamId);
      const currentPhaseTeam = (phase==="primary") ? primaryTeamId : (phase==="steal" ? stealTeamId : null);

      let html = "";
      if (currentPhaseTeam){
        const L = lifeFor(currentPhaseTeam);
        html += `<div class="row" style="flex-wrap:wrap;gap:8px"><div class="sub">Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${escapeHtml(teamName(currentPhaseTeam)||'')}</b></div>`;
        html += `<button class="btn lifeline ${L.time?'used':''}" id="lifeAddTime" ${L.time?'disabled':''} title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª +20 Ø«Ø§Ù†ÙŠØ©">+20 Ø«Ø§Ù†ÙŠØ©</button>`;
        html += `<button class="btn lifeline ${L.double?'used':''}" id="lifeDouble" ${L.double?'disabled':''} title="Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆØ²">Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·</button>`;
        html += `<button class="btn lifeline ${L.two?'used':''}" id="lifeTwo" ${L.two?'disabled':''} title="Ø³Ù…Ø§Ø­ Ø¨Ù…Ø­Ø§ÙˆÙ„ØªÙŠÙ†">Ù…Ø­Ø§ÙˆÙ„ØªØ§Ù†</button>`;
        if (twoAnswersTeam===currentPhaseTeam){
          html += `<span class="chip">Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©: <b id="twoLeft">${twoLeft}</b></span>
                   <button class="btn" id="btnWrongAttempt">ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ø§Ø·Ø¦Ø©</button>`;
        }
        html += `</div>`;
      }
      html += `<div class="panel" style="border-style:dashed">
        <div class="sub" style="margin-bottom:6px"><b>Ø³Ø±Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„</b> â€” Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ Ø£Ø«Ù†Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚):</div>`;
      if (phase==="primary"){
        teams.filter(t=>t.id!==primaryTeamId).forEach(t=>{
          const L = lifeFor(t.id);
          html += `<button class="btn lifeline ${L.steal?'used':''}" data-steal="${t.id}" ${L.steal?'disabled':''} title="Ø³Ø±Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¢Ù† (${settings.stealSec||10} Ø«)">${escapeHtml(t.name||'')}</button>`;
        });
      } else { html += `<span class="sub">Ø§Ù„Ø³Ø±Ù‚Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ø®Ù„Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ.</span>`; }
      html += `</div>`;

      lifelinesArea.innerHTML = html;

      if (currentPhaseTeam){
        const L = ensureLife(currentPhaseTeam);
        const addTime = $("#lifeAddTime"); const dbl = $("#lifeDouble"); const two = $("#lifeTwo");
        if (addTime) addEvent(addTime, "click", ()=>{ if (L.time) return; setSeconds(Number(tLeft.dataset.val||"0") + 20); L.time = true; saveLife(); renderTeams(); renderLifelines(); });
        if (dbl) addEvent(dbl, "click", ()=>{ if (L.double) return; doubleForTeam = currentPhaseTeam; L.double = true; saveLife(); renderTeams(); renderLifelines(); });
        if (two) addEvent(two, "click", ()=>{ if (L.two) return; twoAnswersTeam = currentPhaseTeam; twoLeft = 1; L.two = true; saveLife(); renderTeams(); renderLifelines(); });
        const wrongBtn = $("#btnWrongAttempt");
        if (wrongBtn) addEvent(wrongBtn, "click", ()=>{ if (twoAnswersTeam===currentPhaseTeam && twoLeft>0){ twoLeft -= 1; const span=$("#twoLeft"); if(span) span.textContent = String(twoLeft); } });
      }
      $$("[data-steal]").forEach(btn=>{
        addEvent(btn, "click", (e)=>{
          const id = e.currentTarget.getAttribute("data-steal");
          const L = ensureLife(id);
          if (L.steal || phase!=="primary") return;
          L.steal = true; saveLife(); renderTeams();
          stealTeamId = id;
          startStealPhase();
        });
      });
    }
    function addEvent(node, type, handler){ try{ node.addEventListener(type, handler, false); }catch(e){ console.warn("Listener fail", e); } }

    // ==== Setup (inline) ====
    function openSetup(){ setup.style.display = setup.style.display==="none" ? "block" : "none"; if (setup.style.display==="block"){ populateChecklist(); } }
    function populateChecklist(){
      numCats.value = selectedNum;
      const all = categories();
      const chosen = new Set(activeCategories());
      catsChecklist.innerHTML = all.map(c=>{
        const count = packCount(c);
        const cur = currentPackIndex(c);
        const sel = Array.from({length: Math.max(1,count)}, (_,i)=>`<option value="${i}" ${i===cur?"selected":""}>Ø­Ø²Ù…Ø© ${i+1}</option>`).join("");
        const img = catImg(c);
        return `<div class="catRow">
          <span class="thumb" style="background-image:url('${img?img.replace(/'/g,"%27"):''}')"></span>
          <label class="row" style="gap:8px"><input type="checkbox" class="catCheck" value="${c}" ${chosen.has(c)?"checked":""}/><span>${escapeHtml(c)}</span></label>
          <div></div>
          <select class="packPick" data-cat="${escapeHtml(c)}" ${chosen.has(c)?"":"disabled"}>${sel}</select>
        </div>`;
      }).join("");
      enforceNumSelection();
    }
    function getCheckedCats(){ return $$("input.catCheck", catsChecklist).filter(i=>i.checked).map(i=>i.value); }
    function enforceNumSelection(){
      selectedNum = Math.max(3, Math.min(10, Number(numCats.value)||6));
      const checks = $$("input.catCheck", catsChecklist);
      if (getCheckedCats().length > selectedNum){
        while(getCheckedCats().length > selectedNum){ const last = checks.reverse().find(i=>i.checked); if(last) last.checked = false; }
      }
      const atLimit = getCheckedCats().length >= selectedNum;
      checks.forEach(i=>{
        const cat = i.value; const picker = catsChecklist.querySelector(`.packPick[data-cat="${CSS.escape(cat)}"]`);
        if(!i.checked){ i.disabled = atLimit; if(picker){ picker.disabled = true; } }
        else { i.disabled = false; if(picker){ picker.disabled = false; } }
      });
      btnStartGame.disabled = (getCheckedCats().length !== selectedNum);
    }

    // ==== Admin Manager ====
    let adminCat = null;
    let adminPackIdx = 0;

    function defaultQ(){ return {type:"open", text:"", answer:"", hint:"", img:""}; }
    function defaultPack(){
      return { 100: [ defaultQ(), defaultQ() ], 200: [ defaultQ(), defaultQ() ], 300: [ defaultQ(), defaultQ() ], 400: defaultQ() };
    }
    function normalizeQ(q){
      return {
        type: (q && q.type==='mcq') ? 'mcq' : 'open',
        text: q && q.text || "",
        answer: q && q.answer || "",
        hint: q && q.hint || "",
        options: Array.isArray(q && q.options) ? q.options : (q && typeof q.options==='string'? q.options.split('|').map(s=>s.trim()).filter(Boolean): []),
        correct: Math.max(1, Number(q && q.correct)||1),
        img: q && q.img || ""
      };
    }
    function normalizePack(p){
      const np = defaultPack();
      [100,200,300].forEach(v=>{
        const val = p[v];
        if (Array.isArray(val)){
          np[v][0] = normalizeQ(val[0] || {});
          np[v][1] = normalizeQ(val[1] || {});
        } else if (val && typeof val === 'object'){
          np[v][0] = normalizeQ(val);
        }
      });
      if (p[400]){ if (Array.isArray(p[400])) np[400] = normalizeQ(p[400][0] || {}); else np[400] = normalizeQ(p[400]); }
      return np;
    }

    function openAdmin(){ admin.style.display = admin.style.display==="none" ? "block" : "none"; if (admin.style.display==="block"){ renderAdmin(); } }
    function renderAdmin(){
      if (!adminCat || !(adminCat in PACKS)){ adminCat = categories()[0] || null; adminPackIdx = 0; }
      // categories list
      catList.innerHTML = categories().map(c=>{
        const img = catImg(c);
        return `<button class="btn ${c===adminCat?'brand':''}" data-cat="${c}">
          <span class="thumb" style="width:22px;height:22px;border-radius:6px;background-image:url('${img?img.replace(/'/g,"%27"):''}');border:1px solid #2a356b"></span>
          ${escapeHtml(c)} <span class="mini">(${packCount(c)} Ø­Ø²Ù…Ø©)</span></button>`;
      }).join("");
      $$("[data-cat]", catList).forEach(btn=> btn.addEventListener("click", e=>{ adminCat = e.currentTarget.getAttribute("data-cat"); adminPackIdx = 0; renderAdmin(); }));
      // packs list
      const n = packCount(adminCat);
      let packBtns = n? "" : `<div class="sub">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙØ²Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.</div>`;
      for(let i=0;i<n;i++){ packBtns += `<button class="btn ${i===adminPackIdx?'brand':''}" data-pack="${i}">Ø­Ø²Ù…Ø© ${i+1}</button>`; }
      packList.innerHTML = packBtns;
      $$("[data-pack]", packList).forEach(btn=> btn.addEventListener("click", e=>{ adminPackIdx = Number(e.currentTarget.getAttribute("data-pack")); renderAdmin(); }));
      // editor
      editorTitle.textContent = adminCat ? `ØªØ­Ø±ÙŠØ± Ø§Ù„Ø­Ø²Ù…Ø© â€” ${adminCat}` : "Ø§Ù„Ù…Ø­Ø±Ù‘Ø±";
      editorSub.textContent = (n>0) ? `Ø­Ø²Ù…Ø© ${adminPackIdx+1} Ù…Ù† ${n}` : "Ø£Ø¶Ù Ø­Ø²Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.";
      refreshCatSettings();
      renderPackEditor();
    }

    function refreshCatSettings(){
      if (!adminCat){ catPreview.style.backgroundImage=""; catImgUrl.value=""; return; }
      const img = META[adminCat]?.img || coverDataUrl(adminCat);
      catPreview.style.backgroundImage = img ? `url('${img.replace(/'/g,"%27")}')` : "";
      catImgUrl.value = META[adminCat]?.img || "";
    }

    function qBlock(q, label, key){
      const optBlock = `
        <div class="kv mc" style="display:${q.type==='mcq'?'grid':'none'}">
          <label>Ø®ÙŠØ§Ø±Ø§Øª (|)</label>
          <textarea data-field="options-${key}" placeholder="Ù…Ø«Ø§Ù„: Ø®ÙŠØ§Ø± Ø£|Ø®ÙŠØ§Ø± Ø¨|Ø®ÙŠØ§Ø± Ø¬">${(q.options||[]).join('|')}</textarea>
        </div>
        <div class="kv mc" style="display:${q.type==='mcq'?'grid':'none'}">
          <label>Ø§Ù„ØµØ­ (#)</label>
          <input type="number" min="1" value="${(q.correct||1)}" data-field="correct-${key}" />
        </div>`;
      const imgBlock = `
        <div class="kv">
          <label>ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ (Ø±Ø§Ø¨Ø·)</label>
          <input data-field="img-${key}" value="${q.img||''}" placeholder="https://... Ø£Ùˆ ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹"/>
        </div>
        <div class="row">
          <label class="btn">
            Ø±ÙØ¹ ØµÙˆØ±Ø©<input type="file" accept="image/*" data-upload="img-${key}" style="display:none">
          </label>
          <button class="btn red" data-clear="img-${key}">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
        </div>
        <div class="row"><img data-preview="img-${key}" style="max-width:100%; max-height:120px; border-radius:8px; border:1px solid #2b3469; display:${q.img?'block':'none'}" src="${q.img||''}"></div>
      `;
      return `
        <div class="fieldset">
          <div class="row" style="justify-content:space-between;align-items:center"><strong>${label}</strong></div>
          <div class="kv">
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <select data-field="type-${key}">
              <option value="open" ${q.type!=='mcq'?'selected':''}>Ø³Ø¤Ø§Ù„ Ù…ÙØªÙˆØ­</option>
              <option value="mcq" ${q.type==='mcq'?'selected':''}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
            </select>
          </div>
          <div class="kv">
            <label>Ø§Ù„Ø³Ø¤Ø§Ù„</label>
            <textarea data-field="text-${key}" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„...">${q.text||''}</textarea>
          </div>
          ${imgBlock}
          <div class="kv">
            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
            <input data-field="answer-${key}" value="${q.answer||''}"/>
          </div>
          <div class="kv">
            <label>ØªÙ„Ù…ÙŠØ­</label>
            <input data-field="hint-${key}" value="${q.hint||''}"/>
          </div>
          ${optBlock}
        </div>`;
    }

    function renderPackEditor(){
      const n = packCount(adminCat);
      if (!adminCat || n===0){ packEditor.innerHTML = `<div class="sub">â€”</div>`; return; }
      const pack = PACKS[adminCat][adminPackIdx] || defaultPack();

      const h100a = qBlock(pack[100][0] || {}, "Ù¡Ù Ù  (Ø£)", "100a");
      const h100b = qBlock(pack[100][1] || {}, "Ù¡Ù Ù  (Ø¨)", "100b");
      const h200a = qBlock(pack[200][0] || {}, "Ù¢Ù Ù  (Ø£)", "200a");
      const h200b = qBlock(pack[200][1] || {}, "Ù¢Ù Ù  (Ø¨)", "200b");
      const h300a = qBlock(pack[300][0] || {}, "Ù£Ù Ù  (Ø£)", "300a");
      const h300b = qBlock(pack[300][1] || {}, "Ù£Ù Ù  (Ø¨)", "300b");
      const h400 = qBlock(Array.isArray(pack[400])? (pack[400][0]||{}) : pack[400] || {}, "Ù¤Ù Ù  (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)", "400");

      packEditor.innerHTML = h100a + h100b + h200a + h200b + h300a + h300b + h400;

      const applyWire = (pts, sub, key)=>{
        const getQ = ()=> {
          PACKS[adminCat][adminPackIdx][pts] = PACKS[adminCat][adminPackIdx][pts] || [defaultQ(), defaultQ()];
          if (sub===null){ PACKS[adminCat][adminPackIdx][pts] = normalizeQ(PACKS[adminCat][adminPackIdx][pts]); return PACKS[adminCat][adminPackIdx][pts]; }
          PACKS[adminCat][adminPackIdx][pts][sub] = PACKS[adminCat][adminPackIdx][pts][sub] || defaultQ();
          return PACKS[adminCat][adminPackIdx][pts][sub];
        };
        const typeSel = packEditor.querySelector(`[data-field="type-${key}"]`);
        const qText = packEditor.querySelector(`[data-field="text-${key}"]`);
        const ans = packEditor.querySelector(`[data-field="answer-${key}"]`);
        const hint = packEditor.querySelector(`[data-field="hint-${key}"]`);
        const opts = packEditor.querySelector(`[data-field="options-${key}"]`);
        const corr = packEditor.querySelector(`[data-field="correct-${key}"]`);
        const imgInput = packEditor.querySelector(`[data-field="img-${key}"]`);
        const upload = packEditor.querySelector(`[data-upload="img-${key}"]`);
        const clear = packEditor.querySelector(`[data-clear="img-${key}"]`);
        const preview = packEditor.querySelector(`[data-preview="img-${key}"]`);

        const refreshMC = ()=>{
          const q = getQ();
          const show = q.type === 'mcq';
          $$(".mc", packEditor).forEach(el=>{
            const hasThis = el.querySelector(`[data-field$="${key}"]`) != null;
            if (hasThis) el.style.display = show? 'grid':'none';
          });
        };
        const refreshPreview = ()=>{
          const q = getQ();
          if (q.img){ preview.src = q.img; preview.style.display = 'block'; }
          else { preview.removeAttribute('src'); preview.style.display = 'none'; }
        };

        typeSel.addEventListener("change", ()=>{ const q=getQ(); q.type = typeSel.value; refreshMC(); savePacks(); showOk("ØªÙ… ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„"); });
        qText.addEventListener("input", ()=>{ const q=getQ(); q.text = qText.value; savePacks(); });
        ans.addEventListener("input", ()=>{ const q=getQ(); q.answer = ans.value; savePacks(); });
        hint.addEventListener("input", ()=>{ const q=getQ(); q.hint = hint.value; savePacks(); });
        if (opts) opts.addEventListener("input", ()=>{ const q=getQ(); q.options = opts.value.split('|').map(s=>s.trim()).filter(Boolean); savePacks(); });
        if (corr) corr.addEventListener("input", ()=>{ const q=getQ(); q.correct = Math.max(1, Number(corr.value)||1); savePacks(); });

        imgInput.addEventListener("input", ()=>{ const q=getQ(); q.img = imgInput.value; savePacks(); refreshPreview(); });
        if (upload) upload.addEventListener("change", (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const r = new FileReader();
          r.onload = ()=>{ const q=getQ(); q.img = String(r.result); imgInput.value = q.img; savePacks(); refreshPreview(); showOk("ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„."); };
          r.readAsDataURL(f);
          e.target.value = "";
        });
        if (clear) clear.addEventListener("click", ()=>{ const q=getQ(); q.img=""; imgInput.value=""; savePacks(); refreshPreview(); });

        refreshMC(); refreshPreview();
      };
      applyWire(100,0,"100a"); applyWire(100,1,"100b");
      applyWire(200,0,"200a"); applyWire(200,1,"200b");
      applyWire(300,0,"300a"); applyWire(300,1,"300b");
      // 400 (reserve)
      (function(){
        const key="400";
        const getQ = ()=>{ PACKS[adminCat][adminPackIdx][400] = PACKS[adminCat][adminPackIdx][400] || defaultQ(); return PACKS[adminCat][adminPackIdx][400]; };
        const typeSel = packEditor.querySelector(`[data-field="type-${key}"]`);
        const qText = packEditor.querySelector(`[data-field="text-${key}"]`);
        const ans = packEditor.querySelector(`[data-field="answer-${key}"]`);
        const hint = packEditor.querySelector(`[data-field="hint-${key}"]`);
        const opts = packEditor.querySelector(`[data-field="options-${key}"]`);
        const corr = packEditor.querySelector(`[data-field="correct-${key}"]`);
        const imgInput = packEditor.querySelector(`[data-field="img-${key}"]`);
        const upload = packEditor.querySelector(`[data-upload="img-${key}"]`);
        const clear = packEditor.querySelector(`[data-clear="img-${key}"]`);
        const preview = packEditor.querySelector(`[data-preview="img-${key}"]`);

        const refreshMC = ()=>{
          const q = getQ();
          const show = q.type === 'mcq';
          $$(".mc", packEditor).forEach(el=>{
            const hasThis = el.querySelector(`[data-field$="${key}"]`) != null;
            if (hasThis) el.style.display = show? 'grid':'none';
          });
        };
        const refreshPreview = ()=>{
          const q = getQ();
          if (q.img){ preview.src = q.img; preview.style.display = 'block'; }
          else { preview.removeAttribute('src'); preview.style.display = 'none'; }
        };

        typeSel.addEventListener("change", ()=>{ const q=getQ(); q.type = typeSel.value; refreshMC(); savePacks(); });
        qText.addEventListener("input", ()=>{ const q=getQ(); q.text = qText.value; savePacks(); });
        ans.addEventListener("input", ()=>{ const q=getQ(); q.answer = ans.value; savePacks(); });
        hint.addEventListener("input", ()=>{ const q=getQ(); q.hint = hint.value; savePacks(); });
        if (opts) opts.addEventListener("input", ()=>{ const q=getQ(); q.options = opts.value.split('|').map(s=>s.trim()).filter(Boolean); savePacks(); });
        if (corr) corr.addEventListener("input", ()=>{ const q=getQ(); q.correct = Math.max(1, Number(corr.value)||1); savePacks(); });
        imgInput.addEventListener("input", ()=>{ const q=getQ(); q.img = imgInput.value; savePacks(); refreshPreview(); });
        if (upload) upload.addEventListener("change", (e)=>{
          const f = e.target.files[0]; if(!f) return;
          const r = new FileReader();
          r.onload = ()=>{ const q=getQ(); q.img = String(r.result); imgInput.value = q.img; savePacks(); refreshPreview(); showOk("ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„."); };
          r.readAsDataURL(f);
          e.target.value = "";
        });
        if (clear) clear.addEventListener("click", ()=>{ const q=getQ(); q.img=""; imgInput.value=""; savePacks(); refreshPreview(); });

        refreshMC(); refreshPreview();
      })();
    }

    // Cat actions
    btnAddCat.addEventListener("click", ()=>{
      const name = prompt("Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
      if (!name) return;
      if (PACKS[name]) { showError("Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§."); return; }
      PACKS[name] = [ defaultPack() ];
      META[name] = { img: coverDataUrl(name) };
      store.setItem(LS.packs, JSON.stringify({packs:PACKS}));
      store.setItem(LS.meta, JSON.stringify(META));
      adminCat = name; adminPackIdx = 0;
      usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¨ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.");
    });
    btnRenameCat.addEventListener("click", ()=>{
      if (!adminCat) return;
      const name = prompt("Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯:", adminCat);
      if (!name || name===adminCat) return;
      if (PACKS[name]) { showError("Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."); return; }
      PACKS[name] = PACKS[adminCat]; delete PACKS[adminCat];
      if (META[adminCat]){ META[name] = META[adminCat]; delete META[adminCat]; }
      if (selectedCats){ selectedCats = selectedCats.map(c=>c===adminCat?name:c); store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); store.setItem(LS.numCats, String(selectedNum)); }
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}"); if (p[adminCat]!=null){ p[name]=p[adminCat]; delete p[adminCat]; store.setItem(LS.packIndex, JSON.stringify(p)); }
      adminCat = name;
      usedMap = {}; store.setItem(LS.used, JSON.stringify(usedMap));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); store.setItem(LS.meta, JSON.stringify(META));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©.");
    });
    btnDeleteCat.addEventListener("click", ()=>{
      if (!adminCat) return;
      if (!confirm(`Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© "${adminCat}" Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ`)) return;
      delete PACKS[adminCat];
      delete META[adminCat];
      if (selectedCats){ selectedCats = selectedCats.filter(c=>c!==adminCat); store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); }
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}"); delete p[adminCat]; store.setItem(LS.packIndex, JSON.stringify(p));
      adminCat = categories()[0] || null; adminPackIdx = 0;
      usedMap = {}; store.setItem(LS.used, JSON.stringify(usedMap));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); store.setItem(LS.meta, JSON.stringify(META));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©.");
    });

    // Pack actions
    btnAddPack.addEventListener("click", ()=>{
      if (!adminCat) return;
      PACKS[adminCat] = PACKS[adminCat] || [];
      PACKS[adminCat].push(defaultPack());
      adminPackIdx = PACKS[adminCat].length-1;
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø©.");
    });
    btnDupPack.addEventListener("click", ()=>{
      if (!adminCat || packCount(adminCat)===0) return;
      const dup = deepClone(PACKS[adminCat][adminPackIdx]);
      PACKS[adminCat].push(dup);
      adminPackIdx = PACKS[adminCat].length-1;
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø­Ø²Ù…Ø©.");
    });
    btnDelPack.addEventListener("click", ()=>{
      if (!adminCat || packCount(adminCat)===0) return;
      if (!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø©ØŸ")) return;
      PACKS[adminCat].splice(adminPackIdx,1);
      const p = JSON.parse(store.getItem(LS.packIndex)||"{}");
      if ((p[adminCat]||0) >= packCount(adminCat)){ p[adminCat]=0; store.setItem(LS.packIndex, JSON.stringify(p)); }
      adminPackIdx = Math.max(0, Math.min(adminPackIdx, packCount(adminCat)-1));
      store.setItem(LS.packs, JSON.stringify({packs:PACKS})); usedMap={}; store.setItem(LS.used, JSON.stringify(usedMap));
      renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
      showOk("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø²Ù…Ø©.");
    });

    // Save/Clear/Auto category image
    btnSaveCatImg.addEventListener("click", ()=>{ if (!adminCat) return; const url = (catImgUrl.value||"").trim(); META[adminCat] = META[adminCat] || {}; META[adminCat].img = url; saveMeta(); refreshCatSettings(); renderBoard(); showOk("ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø©."); });
    btnAutoCatImg.addEventListener("click", ()=>{ if (!adminCat) return; META[adminCat] = META[adminCat] || {}; META[adminCat].img = coverDataUrl(adminCat); saveMeta(); refreshCatSettings(); renderBoard(); showOk("ØªÙ… ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§."); });
    btnClearCatImg.addEventListener("click", ()=>{ if (!adminCat) return; META[adminCat] = META[adminCat] || {}; META[adminCat].img = ""; saveMeta(); refreshCatSettings(); renderBoard(); showOk("ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø©."); });
    catImgFile.addEventListener("change", (e)=>{ const f = e.target.files[0]; if(!f || !adminCat) return; const r = new FileReader(); r.onload = ()=>{ META[adminCat] = META[adminCat] || {}; META[adminCat].img = String(r.result); saveMeta(); refreshCatSettings(); renderBoard(); showOk("ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§."); }; r.readAsDataURL(f); e.target.value = ""; });

    // Photo search (optional online)
    btnSaveKeys.addEventListener("click", ()=>{ API.unsplash = (unsplashKey.value||"").trim(); API.pixabay = (pixabayKey.value||"").trim(); store.setItem(LS.api, JSON.stringify(API)); showOk("ØªÙ… Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API Ù…Ø­Ù„ÙŠÙ‹Ø§."); });
    async function searchUnsplash(q){ if (!API.unsplash){ showError("Ø£Ø¯Ø®Ù„ Unsplash Access Key Ø£ÙˆÙ„Ù‹Ø§.", ""); return []; } const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(q)}&per_page=24&orientation=landscape&content_filter=high&client_id=${encodeURIComponent(API.unsplash)}`; const res = await fetch(url); if (!res.ok) throw new Error("Unsplash error " + res.status); const data = await res.json(); return (data.results||[]).map(r=>({thumb:r.urls.small, full:r.urls.regular})); }
    async function searchPixabay(q){ if (!API.pixabay){ showError("Ø£Ø¯Ø®Ù„ Pixabay API Key Ø£ÙˆÙ„Ù‹Ø§.", ""); return []; } const url = `https://pixabay.com/api/?key=${encodeURIComponent(API.pixabay)}&q=${encodeURIComponent(q)}&image_type=photo&orientation=horizontal&per_page=25&safesearch=true`; const res = await fetch(url); if (!res.ok) throw new Error("Pixabay error " + res.status); const data = await res.json(); return (data.hits||[]).map(r=>({thumb:r.previewURL, full:r.webformatURL})); }
    btnSearchImg.addEventListener("click", async ()=>{
      const q = (imgQuery.value||"").trim();
      if (!q){ showError("Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«.", ""); return; }
      imgResults.innerHTML = "<div class='sub'>... Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«</div>";
      try{
        const prov = imgProvider.value;
        const items = prov==='unsplash' ? await searchUnsplash(q) : await searchPixabay(q);
        if (!items || !items.length){ imgResults.innerHTML = "<div class='sub'>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</div>"; return; }
        imgResults.innerHTML = items.map((it,i)=>`
          <div class="resultCard">
            <img src="${it.thumb}" alt="" />
            <div class="meta">
              <span>${i+1}</span>
              <button class="btn" data-choose="${encodeURIComponent(it.full)}" title="ØªØ¹ÙŠÙŠÙ† ÙƒØµÙˆØ±Ø© Ù„Ù„ÙØ¦Ø©">Ø§Ø®ØªÙŠØ§Ø±</button>
            </div>
          </div>
        `).join("");
        $$("[data-choose]").forEach(b=> b.addEventListener("click", e=>{
          const full = decodeURIComponent(e.currentTarget.getAttribute("data-choose"));
          if (!adminCat) return;
          META[adminCat] = META[adminCat] || {};
          META[adminCat].img = full;
          saveMeta();
          refreshCatSettings();
          renderBoard();
          showOk("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„ÙØ¦Ø©.");
        }));
      }catch(err){ showError("ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ±", err); imgResults.innerHTML=""; }
    });

    // Export / Import
    btnExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify({packs:PACKS, meta:META}, null, 2)], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "seen-jeem-data-v6.5.json";
      a.click();
      URL.revokeObjectURL(a.href);
      showOk("ØªÙ… ØªØµØ¯ÙŠØ± (Ø­ÙØ²Ù… + ØµÙˆØ± Ø§Ù„ÙØ¦Ø§Øª + ØµÙˆØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©).");
    });

    document.addEventListener("keydown", (e)=>{ const lbl=document.getElementById("lblImport"); if (lbl && e.altKey) lbl.firstChild.textContent = "Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„)"; });
    document.addEventListener("keyup", (e)=>{ const lbl=document.getElementById("lblImport"); if (lbl && !e.altKey) lbl.firstChild.textContent = "Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø¥Ø¶Ø§ÙØ©)"; });

    fileImport.addEventListener("change", (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const replaceAll = (window.event && window.event.altKey) || false;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const raw = JSON.parse(String(reader.result));
          let packsData = raw.packs ?? raw;
          let metaData = raw.meta || {};
          if (Array.isArray(packsData)){
            const targetCat = prompt("Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø­ÙØ²Ù… Ø¥Ù„ÙŠÙ‡Ø§ (ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©):");
            if (!targetCat) throw new Error("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.");
            packsData = { [targetCat]: packsData };
          }
          if (replaceAll){ PACKS = {}; META = {}; }
          if (packsData && typeof packsData === "object"){
            for (const cat of Object.keys(packsData)){
              const arr = packsData[cat];
              if (!Array.isArray(arr)) continue;
              if (!PACKS[cat]) PACKS[cat] = [];
              arr.forEach(p=>{ PACKS[cat].push(normalizePack(p)); });
              META[cat] = META[cat] || { img: coverDataUrl(cat) };
            }
          }
          if (metaData && typeof metaData === "object"){
            for (const cat of Object.keys(metaData)){
              META[cat] = META[cat] || {};
              if (metaData[cat].img) META[cat].img = metaData[cat].img;
            }
          }
          savePacks(); saveMeta();
          usedMap={}; saveUsed();
          renderBoard(); populateChecklist(); renderSelectedCatsView(); renderAdmin();
          showOk(replaceAll ? `Ø§ÙØ³ØªØ¨Ø¯Ù„Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø­ÙØ²Ù… + ØµÙˆØ±).` : `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„Ø¯Ù…Ø¬.`);
        }catch(err){ showError("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", err); }
      };
      reader.readAsText(f, "utf-8");
      e.target.value = "";
    });

    // ==== Events ====
    $("#btnTest").addEventListener("click", ()=>{ const now = Date.now(); $("#btnTest").textContent = "ØªÙ…! " + now.toString().slice(-6); });
    btnManage.addEventListener("click", openAdmin);
    btnShowSetup.addEventListener("click", openSetup);
    numCats.addEventListener("input", enforceNumSelection);
    catsChecklist.addEventListener("change", (e)=>{ if (e.target.classList.contains("catCheck")) enforceNumSelection(); });
    btnRandCats.addEventListener("click", ()=>{
      const all = categories(); const N = Math.min(selectedNum, all.length);
      const chosen = shuffle(all).slice(0,N);
      $$("input.catCheck", catsChecklist).forEach(i => i.checked = chosen.includes(i.value));
      enforceNumSelection();
    });
    btnStartGame.addEventListener("click", ()=>{
      const cats = $$("input.catCheck", catsChecklist).filter(i=>i.checked).map(i=>i.value);
      cats.forEach(cat => {
        const picker = catsChecklist.querySelector(`.packPick[data-cat="${CSS.escape(cat)}"]`);
        if (picker){ packIndexByCat[cat] = Number(picker.value||"0")|0; }
      });
      store.setItem(LS.packIndex, JSON.stringify(packIndexByCat));
      selectedCats = cats; store.setItem(LS.selectedCats, JSON.stringify(selectedCats)); store.setItem(LS.numCats, String(selectedNum));
      usedMap = {}; saveUsed();
      teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams));
      lifelinesUsed = {}; saveLife();
      renderTeams();
      renderSelectedCatsView(); renderBoard();
      setup.style.display = "none";
    });

    btnAddTeam.addEventListener("click", ()=>{ const t={id:uid(),name:`ÙØ±ÙŠÙ‚ ${teams.length+1}`,score:0}; teams.push(t); ensureLife(t.id); renderTeams(); store.setItem(LS.teams, JSON.stringify(teams)); saveLife(); });
    btnZeroScores.addEventListener("click", ()=>{ teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams)); renderTeams(); });
    btnReset.addEventListener("click", ()=>{ usedMap = {}; saveUsed(); renderBoard(); closeQuestion(); });
    btnNextGame.addEventListener("click", ()=>{
      activeCategories().forEach(cat => { const n = packCount(cat); if (!n) return; packIndexByCat[cat] = (currentPackIndex(cat) + 1) % n; });
      store.setItem(LS.packIndex, JSON.stringify(packIndexByCat));
      usedMap = {}; saveUsed();
      teams = teams.map(t=>({...t, score:0})); store.setItem(LS.teams, JSON.stringify(teams));
      lifelinesUsed = {}; saveLife();
      renderTeams();
      renderBoard(); renderSelectedCatsView(); closeQuestion();
    });

    inpPrimary.addEventListener("input", ()=>{ const n = Math.max(5, Number(inpPrimary.value)||60); settings.primarySec = n; store.setItem(LS.settings, JSON.stringify(settings)); if(phase==="primary") { setSeconds(n); renderLifelines(); } });
    inpSteal.addEventListener("input", ()=>{ const n = Math.max(5, Number(inpSteal.value)||10); settings.stealSec = n; store.setItem(LS.settings, JSON.stringify(settings)); if(phase==="steal") { setSeconds(n); renderLifelines(); } });
    inpTitle.addEventListener("input", ()=>{ settings.boardTitle = inpTitle.value; boardTitle.textContent = settings.boardTitle; store.setItem(LS.settings, JSON.stringify(settings)); });
    chkConfetti.addEventListener("change", ()=>{ settings.showConfetti = chkConfetti.checked; store.setItem(LS.settings, JSON.stringify(settings)); });
    chkAutoTurn.addEventListener("change", ()=>{ settings.autoTurn = chkAutoTurn.checked; store.setItem(LS.settings, JSON.stringify(settings)); });

    btnCloseQ.addEventListener("click", ()=>{ closeQuestion(); });
    btnReveal.addEventListener("click", ()=>{ const shown = answerWrap.style.display!=="none"; answerWrap.style.display = shown?"none":"block"; btnReveal.textContent = shown?"Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©":"Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"; });
    btnPause.addEventListener("click", ()=>{ if(timerInt){ stopTick(); } else { startTick(); } });
    btnResetTimer.addEventListener("click", ()=>{ if (phase==="primary") setSeconds(settings.primarySec||60); else if (phase==="steal") setSeconds(settings.stealSec||10); });
    btnHint.addEventListener("click", ()=>{});
    btnNoOne.addEventListener("click", ()=>{
      if (current && current.cat!=null) {
        const prevPrimary = primaryTeamId;
        markUsed(current.cat, current.pack, current.pts, current.sub);
        closeQuestion();
        advanceTurnAfterQuestion(prevPrimary);
      }
    });
    btnForceSteal.addEventListener("click", ()=>{ if (phase === "primary" && stealTeamId){ startStealPhase(); } });

    // ğŸ”“ Global click un-blocker
    btnClickFix.addEventListener("click", ()=>{
      try{
        document.querySelectorAll('*').forEach(el=>{
          const st = getComputedStyle(el);
          const isOverlay = (st.position==='fixed' || st.position==='sticky') && !el.closest('header') && !el.closest('#setup') && !el.closest('#admin');
          if (isOverlay){ el.style.pointerEvents = 'none'; }
        });
        showOk("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø£ÙŠ Ø·Ø¨Ù‚Ø§Øª Ù‚Ø¯ ØªØ­Ø¬Ø¨ Ø§Ù„Ù†Ù‚Ø±.");
      }catch(e){ showError("ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‚Ø±", e); }
    });

    // ==== Confetti ====
    function confetti(){
      for(let i=0;i<60;i++){
        const s = document.createElement("span");
        s.className = 'fx-star';
        s.textContent = "â˜…"; s.style.position="fixed"; s.style.left = (Math.random()*100) + "vw"; s.style.top = "-2vh"; s.style.fontSize = (12+Math.random()*18)+"px"; s.style.opacity = .9; s.style.transition = "transform 1.2s ease, opacity 1.2s ease"; s.style.zIndex = 9; document.body.appendChild(s);
        requestAnimationFrame(()=>{ s.style.transform = `translateY(${90+Math.random()*10}vh) rotate(${Math.random()*360}deg)`; s.style.opacity = 0; });
        setTimeout(()=> s.remove(), 1300);
      }
    }
    window.confetti = confetti;

    // ==== Initial paint ====
    Object.keys(PACKS).forEach(cat=>{ PACKS[cat] = (PACKS[cat]||[]).map(normalizePack); META[cat] = META[cat] || {}; });
    savePacks(); saveMeta(); saveAPI();
    teams.forEach(t=>ensureLife(t.id)); saveLife();
    renderTeams(); renderSelectedCatsView(); renderBoard();
    if (!selectedCats) { setup.style.display="block"; populateChecklist(); }

  } catch (err) {
    const bar = document.getElementById("errorBar");
    if (bar){ bar.textContent = "âš ï¸ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© â€” " + (err.message||err); bar.style.display="block"; }
    console.error(err);
  }
})();
</script>
</body>
</html>